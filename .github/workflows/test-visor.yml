name: 🧪 Test Visor CLI

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allow manual triggering

jobs:
  test-visor:
    name: Test Visor Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: 🛒 Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: 📦 Install dependencies
        run: npm ci
      
      - name: 🏗️ Build Visor
        run: npm run build
      
      - name: 🔍 Test CLI Basic Functionality
        run: |
          chmod +x ./dist/index.js
          echo "Testing Visor CLI help..."
          ./dist/index.js --cli --help
          
          echo "Testing Visor CLI version..."
          ./dist/index.js --cli --version
      
      - name: 🧪 Test JSON Output
        run: |
          echo "Testing JSON output format..."
          ./dist/index.js --cli --check security --output json 2>/dev/null | jq '.summary.overallScore' || {
            echo "JSON output test failed"
            exit 1
          }
      
      - name: 🧪 Test SARIF Output
        run: |
          echo "Testing SARIF output format..."
          ./dist/index.js --cli --check security --output sarif 2>/dev/null | jq '.version' || {
            echo "SARIF output test failed"
            exit 1
          }
      
      - name: 🧪 Test Markdown Output
        run: |
          echo "Testing Markdown output format..."
          ./dist/index.js --cli --check performance --output markdown 2>&1 | grep -q "Analysis Results" || {
            echo "Markdown output test failed"
            exit 1
          }
      
      - name: 🧪 Test Table Output
        run: |
          echo "Testing Table output format..."
          ./dist/index.js --cli --check style --output table 2>&1 | grep -q "Analysis Summary" || {
            echo "Table output test failed"
            exit 1
          }
      
      - name: 📊 Generate Sample Reports
        run: |
          # Generate reports in all formats for artifact upload (using mock provider)
          ./dist/index.js --cli --check all --config .visor.test.yaml --provider mock --output json 2>/dev/null > sample-report.json || echo '{"error": "Mock provider failed"}' > sample-report.json
          ./dist/index.js --cli --check all --config .visor.test.yaml --provider mock --output sarif 2>/dev/null > sample-report.sarif || echo '{"error": "Mock provider failed"}' > sample-report.sarif
          ./dist/index.js --cli --check all --config .visor.test.yaml --provider mock --output markdown 2>&1 > sample-report.md || echo "Error: Mock provider failed" > sample-report.md
          ./dist/index.js --cli --check all --config .visor.test.yaml --provider mock --output table 2>&1 > sample-report.txt || echo "Error: Mock provider failed" > sample-report.txt
      
      - name: 📈 Upload Sample Reports
        uses: actions/upload-artifact@v4
        with:
          name: visor-sample-reports
          path: |
            sample-report.json
            sample-report.sarif
            sample-report.md
            sample-report.txt
          retention-days: 7
      
      - name: ✅ Verify Configuration
        run: |
          echo "Verifying configuration..."
          if [ -f ".visor.yaml" ]; then
            echo "✅ Custom configuration file found"
            # Basic YAML syntax check
            python3 -c "import yaml; yaml.safe_load(open('.visor.yaml'))" && echo "✅ YAML syntax valid"
          else
            echo "✅ Using default configuration from defaults/ folder"
          fi