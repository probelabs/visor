name: Build and Update Dist

on:
  push:
    branches: [main]
    paths-ignore:
      - 'dist/**'
  workflow_dispatch:

jobs:
  build-dist:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    concurrency:
      group: build-dist-main
      cancel-in-progress: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          rm -rf node_modules package-lock.json
          npm install
          # Explicitly install rollup platform-specific binary
          npm install --no-save @rollup/rollup-linux-x64-gnu

      - name: Remove dist before build (ensure clean bundle)
        run: rm -rf dist

      - name: Build project
        run: npm run build

      - name: Clean transient artifacts from dist (avoid committing runtime noise)
        run: |
          # Remove debug and trace artifacts that can be produced by local/test runs
          rm -rf dist/debug-artifacts || true
          rm -rf dist/traces || true
          # Remove any nested traces directories (e.g., dist/output/traces)
          find dist -type d -name traces -prune -exec rm -rf {} + || true
          # Remove sanitized temp configs and debug trace files if present
          find dist -type f -name '.visor-config-sanitized-*.yaml' -delete || true
          find dist -type f -name 'trace-*.jsonl' -delete || true

      - name: Prepare bundled directory
        run: |
          # Note: dist/index.js is already bundled by ncc during build:cli
          # We just need to organize files for GitHub Actions deployment
          mkdir -p bundled

          # Copy the main bundled file
          cp dist/index.js bundled/index.js

          # Copy additional required files
          if [ -d dist/defaults ]; then
            cp -r dist/defaults bundled/
            echo "‚úÖ Copied defaults to bundle"
          fi

          # Copy schema files if they exist
          if [ -d dist/generated ]; then
            cp -r dist/generated bundled/
            echo "‚úÖ Copied generated schemas to bundle"
          fi

          if [ -d dist/output ]; then
            # Copy output folder but ensure no transient traces are present
            rsync -a --delete --exclude 'traces/**' dist/output/ bundled/output/
            echo "‚úÖ Copied output schemas to bundle (traces excluded)"
          fi

          # Copy SDK build artifacts
          if [ -d dist/sdk ]; then
            cp -r dist/sdk bundled/
            echo "‚úÖ Copied SDK build artifacts to bundle"
          fi

      - name: Update dist files and commit to main
        run: |
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Clean dist directory contents (preserve directory structure)
          echo "üßπ Cleaning dist directory contents..."
          if [ -d dist ]; then
            find dist -mindepth 1 -type f -not -path 'dist/.git*' -delete 2>/dev/null || true
            find dist -mindepth 1 -type d -empty -not -path 'dist/.git*' -delete 2>/dev/null || true
          fi
          mkdir -p dist
          echo "‚úÖ Cleaned dist directory"

          # Copy bundled files to dist/ directory
          cp bundled/index.js dist/

          # Copy additional files if they exist
          if [ -d bundled/defaults ]; then
            cp -r bundled/defaults dist/
            echo "‚úÖ Copied defaults to dist/"
          fi

          if [ -d bundled/generated ]; then
            cp -r bundled/generated dist/
            echo "‚úÖ Copied generated schemas to dist/"
          fi

          # Copy schema files if they exist
          if [ -d bundled/output ]; then
            rsync -a --delete bundled/output/ dist/output/
            echo "‚úÖ Copied output schemas to dist/"
          fi

          # Copy SDK build artifacts if they exist
          if [ -d bundled/sdk ]; then
            cp -r bundled/sdk dist/
            echo "‚úÖ Copied SDK build artifacts to dist/"
          fi

          # Add bundled files to git (force add since dist/ is in .gitignore)
          git add -f dist/

          # Commit and push only if there are changes
          if ! git diff --cached --quiet; then
            git commit --no-verify -m "build: update bundled dist files"
            git push origin main
            echo "‚úÖ Bundled files updated on main"
          else
            echo "‚ÑπÔ∏è No changes to dist files"
          fi

      - name: Mirror current commit to nightly
        run: |
          # Push the same commit to nightly so it always mirrors main (with dist)
          CURRENT_SHA=$(git rev-parse HEAD)
          echo "Mirroring commit $CURRENT_SHA to nightly"
          # Create/force-update nightly to the current HEAD
          git push --force-with-lease origin HEAD:refs/heads/nightly
          echo "‚úÖ Nightly updated"
