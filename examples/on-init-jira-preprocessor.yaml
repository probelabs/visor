version: "1.0"

# Example: on_init Hook with JIRA Preprocessor Pattern
# This demonstrates the new on_init hook to automatically enrich AI prompts
# with JIRA ticket data BEFORE the main check executes.

# NOTE: Custom tools would be defined here but omitted for test compatibility
# In production, define tools like fetch-jira-ticket and extract-jira-keys
#
# tools:
#   fetch-jira-ticket:
#     name: fetch-jira-ticket
#     exec: curl ...
#     parseJson: true
#     transform_js: ...

# Steps demonstrating on_init pattern
steps:
  # Example 1: Single tool invocation
  ai-review-with-jira:
    type: ai
    on_init:
      run:
        # Invoke custom tool to fetch JIRA data
        - tool: fetch-jira-ticket
          with:
            issue_key: "PROJ-123"
          as: jira-context
    prompt: |
      JIRA Context:
      {{ outputs["jira-context"] }}

      Review this PR:
      Title: {{ pr.title }}
      Files: {{ files | map: 'filename' | join: ', ' }}
    ai:
      provider: anthropic
      model: claude-3-5-sonnet-20241022

  # Example 2: Multi-step preprocessing
  advanced-review:
    type: ai
    on_init:
      run:
        # Step 1: Extract JIRA key from PR description
        - tool: extract-jira-keys
          with:
            text: "{{ pr.title }} {{ pr.body }}"
          as: jira-key

        # Step 2: Fetch JIRA details using extracted key
        - tool: fetch-jira-ticket
          with:
            issue_key: "{{ outputs['jira-key'] }}"
          as: jira-data
    prompt: |
      JIRA Issue {{ outputs["jira-key"] }}:
      {{ outputs["jira-data"] }}

      Verify this PR aligns with the JIRA ticket requirements.

      PR Title: {{ pr.title }}
    ai:
      provider: anthropic
      model: claude-3-5-sonnet-20241022

  # Example 3: Dynamic preprocessing with run_js
  smart-review:
    type: ai
    on_init:
      run_js: |
        // Dynamically decide what to fetch based on PR content
        const prText = pr.title + ' ' + pr.body;
        const hasJira = prText.match(/[A-Z]+-[0-9]+/);

        if (hasJira) {
          return [
            { tool: 'extract-jira-keys', with: { text: prText }, as: 'jira-key' },
            { tool: 'fetch-jira-ticket', with: { issue_key: hasJira[0] }, as: 'jira-context' }
          ];
        }

        // No JIRA found, skip preprocessing
        return [];
    prompt: |
      {% if outputs["jira-context"] %}
      JIRA Context:
      {{ outputs["jira-context"] }}
      {% else %}
      No JIRA ticket referenced.
      {% endif %}

      Review this PR:
      {{ pr.title }}
    ai:
      provider: anthropic
      model: claude-3-5-sonnet-20241022

  # Example 4: Helper step invocation
  review-with-helper:
    type: ai
    on_init:
      run:
        # Invoke another check as a helper step
        - step: extract-pr-metadata
          as: metadata
    prompt: |
      PR Metadata:
      {{ outputs["metadata"] | json }}

      Review this PR based on the extracted metadata.
    ai:
      provider: anthropic
      model: claude-3-5-sonnet-20241022

  # Helper step for metadata extraction
  extract-pr-metadata:
    type: command
    exec: |
      echo "{
        \"complexity_score\": {{ files | size }},
        \"has_tests\": {% if files | map: 'filename' | where_contains: 'test' | size > 0 %}true{% else %}false{% endif %},
        \"file_types\": {{ files | map: 'filename' | map: 'split', '.' | map: 'last' | uniq | json }}
      }"
    parseJson: true

  # Example 5: Workflow invocation
  review-with-workflow:
    type: ai
    on_init:
      run:
        - workflow: jira-enrichment-workflow
          with:
            pr_text: "{{ pr.title }} {{ pr.body }}"
          as: enriched-context
    prompt: |
      Context: {{ outputs["enriched-context"] }}

      Review the PR.
    ai:
      provider: anthropic
      model: claude-3-5-sonnet-20241022

# NOTE: Reusable workflows omitted for test compatibility
# In production, define workflows like:
#
# workflows:
#   jira-enrichment-workflow:
#     inputs:
#       pr_text: { type: string, required: true }
#     checks:
#       extract: ...
#       fetch: ...

output:
  pr_comment:
    enabled: true
    format: markdown

tests:
  defaults:
    strict: false
    ai_provider: mock
    fail_on_unexpected_calls: false
  fixtures: []

  cases:
    - name: jira-preprocessing-simple
      description: Test simple JIRA data fetching in on_init
      event: manual
      fixture: gh.pr_open.minimal
      mocks:
        ai-review-with-jira:
          content: "Review complete with JIRA context"
          issues: []
      expect:
        calls:
          - step: ai-review-with-jira
            exactly: 1

    - name: jira-multi-step-preprocessing
      description: Test multi-step JIRA preprocessing (extract + fetch)
      event: manual
      fixture: gh.pr_open.minimal
      mocks:
        advanced-review:
          content: "Advanced review with extracted JIRA data"
          issues: []
      expect:
        calls:
          - step: advanced-review
            exactly: 1

    - name: dynamic-jira-preprocessing
      description: Test dynamic preprocessing with run_js
      event: manual
      fixture: gh.pr_open.minimal
      mocks:
        smart-review:
          content: "Smart review with conditional JIRA context"
          issues: []
      expect:
        calls:
          - step: smart-review
            exactly: 1
