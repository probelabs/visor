# Example Visor configuration using reusable workflows
version: "1.0"

# Import workflow definitions from external files
imports:
  - ./workflows/security-scan.yaml
  - ./workflows/code-quality.yaml
  - ./workflows/quick-pr-check.yaml

# Define checks/steps that use the imported workflows
steps:
  # Use the security scan workflow
  security_review:
    type: workflow
    workflow: security-scan
    args:
      severity_threshold: high
      scan_dependencies: true
      custom_patterns:
        - "Check for environment variable leaks"
        - "Verify authentication middleware"
    on: [pr_opened, pr_updated]
    group: security

  # Use the code quality workflow
  quality_check:
    type: workflow
    workflow: code-quality
    args:
      language: typescript
      complexity_threshold: 12
      enable_formatting: true
    output_mapping:
      score: quality_score
      issues: recommendations
    on: [pr_opened, pr_updated]
    group: quality

  # Use the quick-pr-check workflow
  quick_validation:
    type: workflow
    workflow: quick-pr-check
    args:
      pr_type: "{{ pr.labels contains 'hotfix' ? 'hotfix' : 'feature' }}"
    on: [pr_opened]
    group: validation

  # Combine workflow results in a final check
  final_assessment:
    type: ai
    prompt: |
      Based on the workflow results, provide a final assessment:

      Security Scan Results:
      - Total vulnerabilities: {{ outputs.security_review.total_vulnerabilities }}
      - Critical issues: {{ outputs.security_review.critical_issues | size }}

      Code Quality Results:
      - Quality score: {{ outputs.quality_check.score }}/100
      - Recommendations: {{ outputs.quality_check.issues | join: ', ' }}

      Quick Validation:
      - Status: {{ outputs.quick_validation.approval_status }}

      Provide:
      1. Overall risk assessment
      2. Must-fix issues before merge
      3. Recommendations for improvement
    depends_on: [security_review, quality_check, quick_validation]
    on: [pr_opened, pr_updated]
    group: summary

  # Advanced: Override workflow steps
  custom_security_scan:
    type: workflow
    workflow: security-scan
    args:
      severity_threshold: low
      scan_dependencies: false
    # Override specific steps in the workflow
    overrides:
      secrets:
        prompt: |
          Extra strict secret scanning.
          Include checking for:
          - Base64 encoded secrets
          - Encrypted values that might be keys
          - Configuration files with sensitive data
        timeout: 120
      sql_injection:
        ai_model: claude-3-opus-20240229
    on: [manual]
    command: strict-security
    group: security

  # Chain multiple workflows
  comprehensive_review:
    type: script
    content: |
      // Run multiple workflows in sequence
      const securityResult = outputs.security_review;
      const qualityResult = outputs.quality_check;

      // Custom logic based on workflow outputs
      if (securityResult.total_vulnerabilities > 0 && qualityResult.score < 70) {
        return {
          status: 'blocked',
          message: 'PR has both security and quality issues that must be addressed',
          details: {
            security_issues: securityResult.critical_issues,
            quality_score: qualityResult.score,
            recommendations: qualityResult.recommendations
          }
        };
      }

      return {
        status: 'approved',
        message: 'PR meets minimum requirements',
        score: (100 - securityResult.total_vulnerabilities * 10 + qualityResult.score) / 2
      };
    depends_on: [security_review, quality_check]
    on: [pr_opened, pr_updated]
    group: summary

# Output configuration
output:
  pr_comment:
    format: markdown
    group_by: group
    collapse: true

# Global settings
ai_provider: anthropic
ai_model: claude-3-haiku-20240307
max_parallelism: 3