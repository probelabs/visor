version: "1.0"

# This configuration extends the tools library to reuse tool definitions
extends: ./tools-library.yaml

# Additional project-specific tools can be defined here
tools:
  # Project-specific tool for checking API endpoints
  check-api-endpoints:
    name: check-api-endpoints
    description: Verify all API endpoints are documented
    inputSchema:
      type: object
      properties:
        source_dir:
          type: string
          description: Directory containing API source code
        docs_file:
          type: string
          description: API documentation file
    exec: |
      echo "Checking endpoints in {{ args.source_dir }} against {{ args.docs_file }}"
      grep -r "router\.\(get\|post\|put\|delete\|patch\)" {{ args.source_dir }} |
      sed 's/.*router\.\([a-z]*\).*"\([^"]*\)".*/\1 \2/' |
      sort -u
    transform_js: |
      const endpoints = output.trim().split('\n').filter(l => l);
      return endpoints.map(ep => {
        const [method, path] = ep.split(' ');
        return { method: method.toUpperCase(), path };
      });

# Use both imported and local tools in checks
steps:
  # Use imported git tool
  check-git-status:
    type: mcp
    transport: custom
    method: git-status
    fail_if: "output.length > 10"
    transform_js: |
      if (output.length > 10) {
        return [{
          file: 'repository',
          line: 0,
          message: `Too many uncommitted changes: ${output.length} files`,
          severity: 'warning',
          category: 'style',
          ruleId: 'uncommitted-changes'
        }];
      }
      return [];

  # Use imported git diff stats
  analyze-pr-size:
    type: mcp
    transport: custom
    method: git-diff-stats
    methodArgs:
      base: "{{ pr.base | default: 'main' }}"
    fail_if: "output.filesChanged > 50 || output.insertions > 1000"
    transform_js: |
      const issues = [];
      if (output.filesChanged > 50) {
        issues.push({
          file: 'pull-request',
          line: 0,
          message: `Large PR: ${output.filesChanged} files changed. Consider breaking into smaller PRs.`,
          severity: 'warning',
          category: 'style',
          ruleId: 'large-pr'
        });
      }
      if (output.insertions > 1000) {
        issues.push({
          file: 'pull-request',
          line: 0,
          message: `Too many lines added: ${output.insertions}. This may be difficult to review.`,
          severity: 'warning',
          category: 'style',
          ruleId: 'too-many-lines'
        });
      }
      return issues;

  # Use imported npm audit tool
  security-audit:
    type: mcp
    transport: custom
    method: npm-audit
    if: "files.some(f => f.filename === 'package.json')"
    fail_if: "output.some(i => i.severity === 'error')"

  # Use imported Docker linting tool
  lint-dockerfiles:
    type: mcp
    transport: custom
    method: docker-lint
    forEach: "{{ files | where: 'filename', 'match', 'Dockerfile' }}"
    methodArgs:
      file: "{{ item.filename }}"

  # Use imported ESLint tool
  lint-javascript:
    type: mcp
    transport: custom
    method: eslint-check
    if: "files.some(f => f.filename.endsWith('.js') || f.filename.endsWith('.ts'))"
    methodArgs:
      files: "{{ files | where: 'filename', 'match', '\\.(js|ts)$' | map: 'filename' }}"

  # Use local project-specific tool
  verify-api-docs:
    type: mcp
    transport: custom
    method: check-api-endpoints
    methodArgs:
      source_dir: "./src/routes"
      docs_file: "./docs/api.md"
    transform_js: |
      // Check if all endpoints are documented
      const documented = ['GET /users', 'POST /users', 'GET /posts']; // Would parse from docs_file
      const undocumented = output.filter(ep =>
        !documented.includes(`${ep.method} ${ep.path}`)
      );

      return undocumented.map(ep => ({
        file: 'docs/api.md',
        line: 0,
        message: `Undocumented endpoint: ${ep.method} ${ep.path}`,
        severity: 'warning',
        category: 'documentation',
        ruleId: 'missing-api-docs'
      }));

  # Chain multiple tools together
  comprehensive-check:
    type: mcp
    transport: custom
    method: run-tests
    methodArgs:
      command: "npm test"
      format: "jest"
    on_success:
      - type: mcp
        transport: custom
        method: check-outdated
        methodArgs:
          manager: "npm"
        transform_js: |
          // Only warn about major version updates
          return output
            .filter(pkg => pkg.current.split('.')[0] !== pkg.latest.split('.')[0])
            .map(pkg => ({
              file: 'package.json',
              line: 0,
              message: `Major update available for ${pkg.package}: ${pkg.current} â†’ ${pkg.latest}`,
              severity: 'info',
              category: 'documentation',
              ruleId: 'major-update-available'
            }));

# You can also import tools from remote URLs
# extends: https://example.com/shared-tools.yaml

# Or import multiple tool libraries
# extends:
#   - ./tools-library.yaml
#   - ./security-tools.yaml
#   - https://example.com/quality-tools.yaml

output:
  format: markdown
  groupBy: category