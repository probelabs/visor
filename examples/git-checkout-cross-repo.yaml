# Cross-Repository Checkout Example
#
# This example demonstrates checking out multiple repositories
# and running integration tests.

version: "1.0"

steps:
  # Checkout main application repository
  checkout-app:
    type: git-checkout
    repository: myorg/main-app
    ref: "{{ pr.head }}"
    token: "{{ env.GITHUB_TOKEN }}"
    criticality: internal
    assume: "env.GITHUB_TOKEN"  # Ensure token is available

  # Checkout shared library repository
  checkout-lib:
    type: git-checkout
    repository: myorg/shared-lib
    ref: main
    token: "{{ env.GITHUB_TOKEN }}"
    criticality: internal
    assume: "env.GITHUB_TOKEN"  # Ensure token is available

  # Checkout test utilities repository
  checkout-test-utils:
    type: git-checkout
    repository: myorg/test-utils
    ref: v2.0.0
    token: "{{ env.GITHUB_TOKEN }}"
    criticality: internal
    assume: "env.GITHUB_TOKEN"  # Ensure token is available

  # Install dependencies in all repositories
  install-deps:
    type: command
    depends_on: [checkout-app, checkout-lib, checkout-test-utils]
    exec: |
      echo "Installing dependencies for main app..."
      cd "{{ outputs['checkout-app'].path }}" && npm install

      echo "Installing dependencies for shared lib..."
      cd "{{ outputs['checkout-lib'].path }}" && npm install

      echo "Installing dependencies for test utils..."
      cd "{{ outputs['checkout-test-utils'].path }}" && npm install
    assume: "outputs['checkout-app'] && outputs['checkout-lib'] && outputs['checkout-test-utils']"
    schema: plain
    criticality: internal

  # Run integration tests
  integration-test:
    type: command
    depends_on: [install-deps]
    exec: |
      export LIB_PATH="{{ outputs['checkout-lib'].path }}"
      export TEST_UTILS_PATH="{{ outputs['checkout-test-utils'].path }}"
      npm run test:integration
    working_directory: "{{ outputs['checkout-app'].path }}"
    assume: "outputs['install-deps']"
    schema: plain
    criticality: internal

  # Generate integration report
  report:
    type: command
    depends_on: [integration-test]
    exec: |
      cat << EOF
      # Integration Test Report

      ## Repositories Tested
      - **Main App**: {{ outputs['checkout-app'].repository }}@{{ outputs['checkout-app'].commit }}
      - **Shared Lib**: {{ outputs['checkout-lib'].repository }}@{{ outputs['checkout-lib'].commit }}
      - **Test Utils**: {{ outputs['checkout-test-utils'].repository }}@{{ outputs['checkout-test-utils'].commit }}

      ## Test Results
      Exit Code: {{ outputs['integration-test'].exitCode }}
      Status: {{ outputs['integration-test'].exitCode == 0 ? 'PASSED ✅' : 'FAILED ❌' }}
      EOF
    criticality: info
