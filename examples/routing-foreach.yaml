version: "2.0"

# forEach + failure routing: remediate missing markers, then retry
routing:
  max_loops: 6

steps:
  list:
    type: command
    exec: "echo '[\"alpha\",\"beta\"]'"
    forEach: true

  mark:
    type: command
    depends_on: [list]
    exec: "touch .visor_demo_marker_{{ outputs.list }} && echo '[mark] {{ outputs.list }}'"

  process:
    type: command
    depends_on: [list]
    exec: |
      FILE=".visor_demo_marker_{{ outputs.list }}"
      if [ -f "$FILE" ]; then echo "[process] {{ outputs.list }} ready"; exit 0; fi
      echo "[process] missing marker for {{ outputs.list }}" >&2
      exit 1
    on_fail:
      run: [mark]
      retry: { max: 1, backoff: { mode: fixed, delay_ms: 200 } }

  cleanup:
    type: command
    depends_on: [process]
    exec: "rm -f .visor_demo_marker_* && echo '[cleanup] done'"

