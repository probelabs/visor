version: "2.0"

# Session reuse example: reuse_ai_session: self
# ---------------------------------------------
# This example demonstrates how a single AI step can reuse its own
# ProbeAgent session across multiple loops within the same engine run.
#
# Flow:
#   seed (script) → convo (ai, reuse_ai_session: self, session_mode: append)
#                  └─ on_success.goto_js: loops back to convo up to 3 times
#
# The first time `convo` runs, it creates a new AI session. On subsequent
# iterations in the same run, `reuse_ai_session: self` causes the engine
# to reuse that same session (with `session_mode: append`), so the model
# keeps conversational context.

steps:
  # Simple seed step to provide deterministic input to the AI check.
  seed:
    type: script
    criticality: info
    content: |
      return { text: "hello from seed" };

  # AI step that loops back to itself while reusing its own session.
  convo:
    type: ai
    depends_on: [seed]
    criticality: info
    reuse_ai_session: self
    session_mode: append
    # Keep schema simple here – we only care about call counts in tests.
    ai:
      provider: mock
      model: mock
      disableTools: true
      allowedTools: []
      system_prompt: |
        You are a tiny echo assistant.
        Answer concisely and keep track of how the conversation evolves.
    prompt: |
      You are in a small internal conversation used to test AI session reuse.

      Seed message: {{ outputs['seed'].text }}

      Past convo outputs for this run (if any):
      {% assign hist = outputs_history['convo'] | default: empty %}
      {% if hist and hist.size > 0 %}
      {% for h in hist %}
      - Previous reply {{ forloop.index }} seen in this run.
      {% endfor %}
      {% else %}
      - No previous replies yet in this run.
      {% endif %}
    on_success:
      # Loop this step a few times to exercise reuse_ai_session: self.
      goto_js: |
        // "attempt" is the 1-based execution count for this step in this run.
        // Run convo exactly 3 times, then stop.
        return attempt < 3 ? 'convo' : null;

tests:
  defaults:
    strict: true
    ai_provider: mock

  cases:
    - name: self-session-single-run
      description: |
        Basic smoke test: the workflow executes successfully and the
        convo step runs exactly once. The config itself demonstrates
        reuse_ai_session: self + session_mode: append for workflows
        that route back to the same AI step.
      event: manual
      fixture: local.minimal
      expect:
        calls:
          - step: seed
            exactly: 1
          - step: convo
            exactly: 1
