# Example configuration demonstrating AI retry and fallback mechanisms
# This shows how to configure automatic retries with exponential backoff
# and fallback to alternative AI providers when the primary provider fails

version: '1.0'

# Global AI provider settings with retry and fallback
# Note: Check-level settings (in steps.<name>.ai) override these global settings
ai_provider: anthropic
ai_model: claude-3-5-sonnet-20241022

steps:
  # Example 1: Basic retry configuration
  # Retries the same provider with exponential backoff
  code-review:
    type: ai
    prompt: |
      Review this code for security vulnerabilities and best practices.
      Focus on:
      - Authentication and authorization issues
      - SQL injection and XSS vulnerabilities
      - Sensitive data exposure
    schema: code-review
    on:
      - pr_opened
      - pr_updated
    ai:
      provider: anthropic
      model: claude-3-5-sonnet-20241022
      # Retry configuration for transient failures
      retry:
        maxRetries: 3              # Retry up to 3 times (0-50 allowed)
        initialDelay: 1000         # Start with 1 second delay (0-60000ms)
        maxDelay: 30000            # Cap delay at 30 seconds (0-300000ms)
        backoffFactor: 2           # Double delay each retry (1-10 allowed)
        retryableErrors:           # Optional: custom error patterns to retry on
          - "rate limit"
          - "503"
          - "timeout"

  # Example 2: Automatic fallback with environment detection
  # Automatically falls back to available providers based on env vars
  security-scan:
    type: ai
    prompt: |
      Perform a comprehensive security analysis of the changes.
      Identify critical security vulnerabilities.
    schema: code-review
    on:
      - pr_opened
    ai:
      provider: anthropic
      model: claude-3-5-sonnet-20241022
      retry:
        maxRetries: 2
        initialDelay: 1000
        backoffFactor: 2
      # Automatic fallback to any available provider
      fallback:
        auto: true                 # Enable automatic provider detection
        strategy: any              # Try any available provider
        maxTotalAttempts: 10       # Total attempts across all providers

  # Example 3: Custom fallback provider chain
  # Explicitly specify fallback providers in order
  performance-review:
    type: ai
    prompt: |
      Analyze code for performance issues and optimization opportunities.
    schema: code-review
    on:
      - pr_opened
    ai:
      provider: anthropic
      model: claude-3-5-sonnet-20241022
      retry:
        maxRetries: 2
        initialDelay: 500
        backoffFactor: 2
      # Custom fallback chain
      fallback:
        strategy: custom
        maxTotalAttempts: 8
        providers:
          # First fallback: Try OpenAI GPT-4
          - provider: openai
            model: gpt-4-turbo-preview
            maxRetries: 2           # Per-provider retry override
            apiKey: "${OPENAI_API_KEY}"  # Can reference env vars

          # Second fallback: Try Google Gemini
          - provider: google
            model: gemini-2.0-flash-exp
            maxRetries: 2
            apiKey: "${GOOGLE_API_KEY}"

          # Third fallback: AWS Bedrock (requires AWS credentials)
          - provider: bedrock
            model: anthropic.claude-3-5-sonnet-20241022-v2:0
            maxRetries: 1
            region: us-east-1
            accessKeyId: "${AWS_ACCESS_KEY_ID}"
            secretAccessKey: "${AWS_SECRET_ACCESS_KEY}"

  # Example 4: Same-model fallback strategy
  # Falls back to same model on different providers
  style-review:
    type: ai
    prompt: |
      Review code style and consistency with project conventions.
    schema: code-review
    on:
      - pr_updated
    ai:
      provider: anthropic
      model: claude-3-5-sonnet-20241022
      retry:
        maxRetries: 1
      fallback:
        strategy: same-model      # Try to use same model on other providers
        auto: true
        maxTotalAttempts: 5

  # Example 5: Same-provider fallback strategy
  # Falls back to different models from same provider
  documentation-review:
    type: ai
    prompt: |
      Review documentation for completeness and clarity.
    schema: code-review
    on:
      - pr_opened
    ai:
      provider: anthropic
      model: claude-3-5-sonnet-20241022
      retry:
        maxRetries: 2
      fallback:
        strategy: same-provider    # Try other models from Anthropic
        providers:
          - provider: anthropic
            model: claude-3-opus-20240229
            maxRetries: 1
          - provider: anthropic
            model: claude-3-haiku-20240307
            maxRetries: 1

  # Example 6: Conservative retry with no fallback
  # Useful when you want to fail fast and don't want to try alternatives
  critical-security-check:
    type: ai
    prompt: |
      Perform critical security validation that requires highest accuracy.
    schema: code-review
    on:
      - pr_opened
    ai:
      provider: anthropic
      model: claude-3-opus-20240229  # Use most capable model
      retry:
        maxRetries: 1               # Only retry once
        initialDelay: 2000
      # No fallback - fail if primary provider fails after retries

output:
  pr_comment:
    format: markdown
    group_by: check
    collapse: false
  github_checks:
    enabled: true
    per_check: true

# Notes:
# - Retry logic uses exponential backoff with random jitter to avoid thundering herd
# - Retries automatically detect transient failures (rate limits, timeouts, 503, etc.)
# - Fallback providers are tried in order after primary provider exhausts retries
# - Environment variables are automatically used when fallback.auto is enabled
# - Each provider in fallback chain can have its own retry configuration
# - maxTotalAttempts caps total attempts across all providers to prevent excessive API usage
