# Example reusable workflow for code quality checks
id: code-quality
name: Code Quality Workflow
description: Comprehensive code quality checks including linting, complexity, and best practices
version: "1.0.0"
tags: ["quality", "reusable", "linting"]
category: quality

# Input parameters
inputs:
  - name: language
    description: Programming language to analyze
    schema:
      type: string
      enum: ["javascript", "typescript", "python", "go", "java"]
    required: true

  - name: complexity_threshold
    description: Maximum allowed cyclomatic complexity
    schema:
      type: number
      minimum: 1
      maximum: 20
      default: 10
    default: 10

  - name: enable_formatting
    description: Check code formatting
    schema:
      type: boolean
      default: true
    default: true

  - name: custom_rules
    description: Custom linting rules to apply
    schema:
      type: object
      additionalProperties: true
    required: false

# Output parameters
outputs:
  - name: quality_score
    description: Overall code quality score (0-100)
    value_js: |
      const lintScore = steps.linting?.output?.score || 0;
      const complexityScore = steps.complexity?.output?.score || 0;
      const formattingScore = steps.formatting?.output?.score || 100;
      const weights = { lint: 0.4, complexity: 0.4, formatting: 0.2 };
      return Math.round(
        lintScore * weights.lint +
        complexityScore * weights.complexity +
        formattingScore * weights.formatting
      );

  - name: recommendations
    description: List of recommendations for improvement
    value_js: |
      const recs = [];
      if (steps.linting?.output?.issues?.length > 0) {
        recs.push(`Fix ${steps.linting.output.issues.length} linting issues`);
      }
      if (steps.complexity?.output?.high_complexity_functions?.length > 0) {
        recs.push(`Refactor ${steps.complexity.output.high_complexity_functions.length} complex functions`);
      }
      if (steps.formatting?.output?.issues?.length > 0) {
        recs.push(`Fix ${steps.formatting.output.issues.length} formatting issues`);
      }
      return recs;

  - name: detailed_report
    description: Detailed quality report
    value: |
      Code Quality Report for {{ inputs.language }}:
      ================================================
      Overall Score: {{ outputs.quality_score }}/100

      Linting Results:
      - Issues found: {{ steps.linting.output.issues | size }}
      - Score: {{ steps.linting.output.score }}/100

      Complexity Analysis:
      - High complexity functions: {{ steps.complexity.output.high_complexity_functions | size }}
      - Average complexity: {{ steps.complexity.output.average_complexity }}

      {% if inputs.enable_formatting %}
      Formatting Check:
      - Issues found: {{ steps.formatting.output.issues | size }}
      - Score: {{ steps.formatting.output.score }}/100
      {% endif %}

      Recommendations:
      {% for rec in outputs.recommendations %}
      - {{ rec }}
      {% endfor %}

# Workflow steps
steps:
  linting:
    type: ai
    prompt: |
      Perform linting analysis for {{ inputs.language }} code.
      Check for:
      - Syntax errors
      - Code style violations
      - Best practices violations
      - Unused variables and imports
      - Type errors (if applicable)

      {% if inputs.custom_rules %}
      Additional custom rules to check:
      {{ inputs.custom_rules | json }}
      {% endif %}

      Provide a score from 0-100 based on the issues found.
    focus: style
    schema: code-review
    inputs:
      language:
        source: param
        value: language
      custom_rules:
        source: param
        value: custom_rules

  complexity:
    type: ai
    prompt: |
      Analyze code complexity for {{ inputs.language }}.

      Check for:
      - Cyclomatic complexity (threshold: {{ inputs.complexity_threshold }})
      - Cognitive complexity
      - Nested conditionals
      - Long functions/methods
      - Too many parameters

      Report:
      - List of functions exceeding complexity threshold
      - Average complexity across the codebase
      - Provide a score from 0-100
    focus: architecture
    schema: code-review
    depends_on: [linting]
    inputs:
      language:
        source: param
        value: language
      complexity_threshold:
        source: param
        value: complexity_threshold

  formatting:
    type: command
    exec: |
      case "{{ inputs.language }}" in
        javascript|typescript)
          npx prettier --check "**/*.{js,ts,jsx,tsx}" --list-different || true
          ;;
        python)
          python -m black --check . --diff || true
          ;;
        go)
          gofmt -l . || true
          ;;
        java)
          echo "Java formatting check not implemented"
          ;;
      esac
    if: inputs.enable_formatting === true
    depends_on: [complexity]
    inputs:
      language:
        source: param
        value: language
      enable_formatting:
        source: param
        value: enable_formatting

  best_practices:
    type: ai
    prompt: |
      Review {{ inputs.language }} code for best practices:

      - Design patterns usage
      - SOLID principles adherence
      - Error handling patterns
      - Documentation quality
      - Test coverage indicators
      - Performance considerations

      Provide actionable recommendations.
    focus: architecture
    depends_on: [formatting]
    inputs:
      language:
        source: param
        value: language

  aggregate_results:
    type: noop
    depends_on: [best_practices]
    # This step exists to ensure all previous steps complete
    # The actual aggregation happens in the output parameters

# Example usage
examples:
  - name: TypeScript with strict settings
    description: Strict quality checks for TypeScript
    inputs:
      language: typescript
      complexity_threshold: 8
      enable_formatting: true
      custom_rules:
        no-any: error
        explicit-function-return-type: warning

  - name: Python basic check
    description: Basic quality check for Python code
    inputs:
      language: python
      complexity_threshold: 15
      enable_formatting: false

  - name: Go with formatting
    description: Go quality check with formatting validation
    inputs:
      language: go
      complexity_threshold: 10
      enable_formatting: true