# Reusable workflow for comprehensive security scanning
# This workflow is designed to be imported and used in visor configurations

# Metadata for the workflow
id: security-scan
name: Security Scan Workflow
description: A comprehensive security scan workflow that checks for various vulnerabilities
version: "1.0.0"
tags: ["security", "reusable"]
category: security

# Input parameters with JSON Schema validation
inputs:
  - name: severity_threshold
    description: Minimum severity level to report (critical, high, medium, low)
    schema:
      type: string
      enum: ["critical", "high", "medium", "low"]
      default: "medium"
    default: "medium"
    required: false

  - name: scan_dependencies
    description: Whether to scan dependencies for vulnerabilities
    schema:
      type: boolean
      default: true
    default: true
    required: false

  - name: custom_patterns
    description: Additional security patterns to check
    schema:
      type: array
      items:
        type: string
    required: false

# Output parameters computed after workflow execution
outputs:
  - name: total_vulnerabilities
    description: Total number of vulnerabilities found
    value_js: |
      const secretsCount = steps.secrets?.output?.issues?.length || 0;
      const sqlCount = steps.sql_injection?.output?.issues?.length || 0;
      const xssCount = steps.xss?.output?.issues?.length || 0;
      return secretsCount + sqlCount + xssCount;

  - name: critical_issues
    description: List of critical security issues
    value_js: |
      const allIssues = [
        ...(steps.secrets?.output?.issues || []),
        ...(steps.sql_injection?.output?.issues || []),
        ...(steps.xss?.output?.issues || [])
      ];
      return allIssues.filter(issue => issue.severity === 'critical');

  - name: scan_summary
    description: Summary of the security scan
    value: |
      Security Scan Complete:
      - Secrets: {{ steps.secrets.output.issues | size }} issues
      - SQL Injection: {{ steps.sql_injection.output.issues | size }} issues
      - XSS: {{ steps.xss.output.issues | size }} issues
      Total: {{ outputs.total_vulnerabilities }} vulnerabilities found

# Workflow steps - at root level like regular visor configs
steps:
  secrets:
    type: ai
    prompt: |
      Scan the code for hardcoded secrets, API keys, passwords, and sensitive data.
      Focus on:
      - Hardcoded credentials
      - API keys and tokens
      - Database connection strings
      - Private keys and certificates

      Minimum severity: {{ inputs.severity_threshold }}
    focus: security
    schema: code-review
    inputs:
      severity_threshold:
        source: param
        value: severity_threshold

  sql_injection:
    type: ai
    prompt: |
      Check for SQL injection vulnerabilities.
      Look for:
      - String concatenation in SQL queries
      - Unparameterized queries
      - Dynamic SQL construction
      - User input directly in queries

      Minimum severity: {{ inputs.severity_threshold }}
    focus: security
    schema: code-review
    depends_on: [secrets]
    inputs:
      severity_threshold:
        source: param
        value: severity_threshold

  xss:
    type: ai
    prompt: |
      Check for Cross-Site Scripting (XSS) vulnerabilities.
      Look for:
      - Unescaped user input in HTML
      - innerHTML usage with user data
      - Unsafe templating
      - Missing input validation

      Minimum severity: {{ inputs.severity_threshold }}
    focus: security
    schema: code-review
    depends_on: [secrets]
    inputs:
      severity_threshold:
        source: param
        value: severity_threshold

  dependency_scan:
    type: command
    exec: |
      if [ "{{ inputs.scan_dependencies }}" = "true" ]; then
        npm audit --json || echo '{"vulnerabilities": {}}'
      else
        echo '{"skipped": true}'
      fi
    if: inputs.scan_dependencies === true
    depends_on: [sql_injection, xss]
    inputs:
      scan_dependencies:
        source: param
        value: scan_dependencies

  custom_patterns:
    type: ai
    prompt: |
      {% if inputs.custom_patterns %}
      Check for the following custom security patterns:
      {% for pattern in inputs.custom_patterns %}
      - {{ pattern }}
      {% endfor %}
      {% else %}
      No custom patterns to check.
      {% endif %}
    if: inputs.custom_patterns && inputs.custom_patterns.length > 0
    depends_on: [dependency_scan]
    inputs:
      custom_patterns:
        source: param
        value: custom_patterns

# Example usage snippets
examples:
  - name: Basic security scan
    description: Run with default settings
    inputs:
      severity_threshold: medium
      scan_dependencies: true

  - name: Critical issues only
    description: Only report critical security issues
    inputs:
      severity_threshold: critical
      scan_dependencies: false

  - name: Custom patterns
    description: Include custom security patterns
    inputs:
      severity_threshold: low
      scan_dependencies: true
      custom_patterns:
        - "Check for CORS misconfigurations"
        - "Verify JWT token validation"