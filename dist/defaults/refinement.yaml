version: "1.0"

# 3-Amigos Task Refinement workflow
# Extracted refinement steps for reuse and composition
# Similar to code-review.yaml pattern

inputs:
  - name: context
    required: true
    description: Full context for refinement including ticket details, Jira/Zendesk info, and user request
    schema:
      type: string

outputs:
  - name: issues
    description: Aggregated issues from all persona refinement steps
    value_js: |
      const values = Object.values(outputs || {});
      const all = [];
      for (const v of values) {
        const arr = (v && Array.isArray(v.issues)) ? v.issues : [];
        if (arr.length) all.push(...arr);
      }
      return all;

  - name: hasBlockers
    description: True if any critical or error issues exist (blockers)
    value_js: |
      for (const v of Object.values(outputs || {})) {
        const arr = (v && Array.isArray(v.issues)) ? v.issues : [];
        if (arr.some(i => i && (i.severity === 'critical' || i.severity === 'error'))) return true;
      }
      return false;

steps:
  # PM Persona - Product perspective
  pm:
    type: ai
    group: refinement
    ai:
      skip_code_context: true
      skip_slack_context: false
      disableTools: true
      system_prompt: |
        You are the Product Manager persona in a 3-amigos refinement session.
        Your role is to ensure the problem is well-defined, user needs are clear,
        and business value is articulated.
    schema: refinement
    prompt: |
      Analyze this ticket from a Product perspective:

      {{ inputs.context }}

      ## PM Analysis Areas

      **Problem Definition:**
      - Is the problem statement clear and specific?
      - What user pain point does this address?
      - Is there a measurable definition of success?

      **User & Business Value:**
      - Who is the target user/ICP?
      - What are the user goals?
      - What is the business impact?
      - Are there known workarounds?

      **Scope & Requirements:**
      - Are requirements clearly stated?
      - Are there implicit assumptions that need validation?
      - Is the scope appropriately bounded?
      - Are there dependencies on other features/teams?

      ## Severity Guidelines for PM concerns:
      - **critical**: Missing problem statement, undefined user, or blocked by external dependency
      - **error**: Ambiguous requirements, unclear success criteria, or scope creep risk
      - **warning**: Missing nice-to-have context, unclear priority, or assumption needs validation
      - **info**: Suggestions for improvement, related considerations, or future enhancements

      Return issues array with ruleId format: 'pm/category' (e.g., 'pm/missing-requirement', 'pm/unclear-scope')

  # QA Persona - Quality perspective
  qa:
    type: ai
    group: refinement
    ai:
      skip_code_context: true
      skip_slack_context: false
      disableTools: true
      system_prompt: |
        You are the QA Engineer persona in a 3-amigos refinement session.
        Your role is to ensure testability, define acceptance criteria,
        and identify edge cases and quality risks.
    schema: refinement
    prompt: |
      Analyze this ticket from a QA perspective:

      {{ inputs.context }}

      ## QA Analysis Areas

      **Acceptance Criteria:**
      - Are functional acceptance criteria defined (happy paths)?
      - Are negative/error paths covered?
      - Are edge cases identified?
      - Can criteria be objectively verified?

      **Non-Functional Requirements:**
      - Performance expectations?
      - Security considerations?
      - Scalability requirements?
      - Observability/monitoring needs?

      **Test Strategy:**
      - What test types are needed (unit/integration/e2e/manual)?
      - Are there regression risks?
      - What environments are needed for testing?

      ## Severity Guidelines for QA concerns:
      - **critical**: No acceptance criteria, untestable requirement, or major quality risk
      - **error**: Missing negative test cases, undefined non-functionals, or inadequate test coverage
      - **warning**: Edge cases not documented, test data needs clarification, or minor gaps
      - **info**: Test optimization suggestions, automation opportunities, or monitoring recommendations

      Return issues array with ruleId format: 'qa/category' (e.g., 'qa/missing-criteria', 'qa/no-negative-tests')

  # Engineering Persona - Technical perspective
  eng:
    type: ai
    group: refinement
    ai:
      skip_code_context: true
      skip_slack_context: false
      disableTools: true
      system_prompt: |
        You are the Engineering persona in a 3-amigos refinement session.
        Your role is to assess technical feasibility, identify implementation
        approaches, and surface technical risks and dependencies.
    schema: refinement
    prompt: |
      Analyze this ticket from an Engineering perspective:

      {{ inputs.context }}

      ## Engineering Analysis Areas

      **Technical Scope:**
      - Which system components are affected?
      - What's the implementation approach?
      - Is the scope well-bounded technically?

      **Architecture & Design:**
      - Does this fit existing architecture?
      - Are there design decisions to make?
      - Is there potential for over-engineering?
      - Can we reuse existing code/patterns?

      **Dependencies:**
      - What upstream/downstream systems are affected?
      - Are there external API dependencies?
      - Are there database schema changes?

      **Technical Risks:**
      - What could go wrong technically?
      - Are there performance implications?
      - Security considerations?

      ## Severity Guidelines for Engineering concerns:
      - **critical**: Technically infeasible, blocking dependency, or architectural conflict
      - **error**: Significant technical risk, missing design decision, or high complexity
      - **warning**: Minor technical concerns, refactoring opportunity, or optimization possible
      - **info**: Implementation suggestions, alternative approaches, or future considerations

      Return issues array with ruleId format: 'eng/category' (e.g., 'eng/technical-risk', 'eng/missing-design')

tests:
  defaults:
    strict: true
    ai_provider: mock

  cases:
    - name: basic-refinement-all-personas
      event: manual
      fixture: local.minimal
      mocks:
        pm:
          issues:
            - ruleId: "pm/unclear-scope"
              message: "Scope needs clarification - affects multiple components"
              severity: "warning"
              category: "scope"
        qa:
          issues:
            - ruleId: "qa/missing-criteria"
              message: "No acceptance criteria defined for error handling"
              severity: "error"
              category: "acceptance"
        eng:
          issues:
            - ruleId: "eng/technical-risk"
              message: "Database schema change requires migration plan"
              severity: "warning"
              category: "risk"
      expect:
        calls:
          - step: pm
            exactly: 1
          - step: qa
            exactly: 1
          - step: eng
            exactly: 1
        workflow_output:
          - path: hasBlockers
            equals: true
          - path: issues.length
            equals: 3

    - name: ready-for-implementation
      event: manual
      fixture: local.minimal
      mocks:
        pm:
          issues:
            - ruleId: "pm/well-defined"
              message: "Problem statement is clear and measurable"
              severity: "info"
        qa:
          issues:
            - ruleId: "qa/good-coverage"
              message: "Acceptance criteria cover happy and error paths"
              severity: "info"
        eng:
          issues:
            - ruleId: "eng/straightforward"
              message: "Implementation approach is clear, fits existing patterns"
              severity: "info"
      expect:
        calls:
          - step: pm
            exactly: 1
          - step: qa
            exactly: 1
          - step: eng
            exactly: 1
        workflow_output:
          - path: hasBlockers
            equals: false
          - path: issues.length
            equals: 3
