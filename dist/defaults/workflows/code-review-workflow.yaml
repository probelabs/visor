id: code-review
name: Code Review
description: Reusable code review workflow that analyzes changes and produces structured issues.
version: "1.0.0"

# Minimal reusable code-review workflow used by examples/nested workflows.
# It purposefully focuses on a single AI step that emits code-review schema
# to keep it lightweight, while still producing the canonical issues array
# and convenience outputs for downstream logic.

inputs: []

outputs:
  - name: issues
    description: Aggregated issues from the review step
    value_js: |
      const rev = steps.review?.output || {};
      return Array.isArray(rev.issues) ? rev.issues : [];

  - name: critical_count
    description: Number of critical issues
    value_js: |
      const issues = steps.review?.output?.issues || [];
      return issues.filter(i => i?.severity === 'critical').length;

  - name: error_count
    description: Number of error issues
    value_js: |
      const issues = steps.review?.output?.issues || [];
      return issues.filter(i => i?.severity === 'error').length;

  - name: has_blocking
    description: True if there are any critical or error issues
    value_js: |
      const issues = steps.review?.output?.issues || [];
      return issues.some(i => i?.severity === 'critical' || i?.severity === 'error');

steps:
  review:
    type: ai
    group: review
    # Evaluate on PR events by default; callers can override
    on: [pr_opened, pr_updated]
    prompt: |
      You are a senior reviewer performing a thorough code review.

      Analyze the current pull request using the provided context blocks.
      Produce structured findings with severities and clear, actionable suggestions.

      Context blocks available:
      - <files_summary> list of changed files
      - <commit_diff> commit-level diff
      - <full_diff> full PR diff (may be large)

      When reporting, prefer precise, minimal, actionable changes.

      Output a structured review using the standard code-review schema.
    schema: code-review

