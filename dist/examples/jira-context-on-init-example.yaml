# Example: Using Jira Context Workflow with on_init
#
# This example demonstrates how to use the reusable jira-context workflow
# to automatically fetch Jira issue context before running AI analysis.
#
# The workflow:
# 1. Extracts Jira keys from PR title/body (e.g., "PROJ-123", "DEV-456")
# 2. Fetches full issue details including custom fields
# 3. Formats the context as XML for AI consumption
# 4. Makes it available to the main check via {{ outputs['jira-context'] }}
#
# Required environment variables:
#   JIRA_BASE_URL - https://company.atlassian.net
#   JIRA_EMAIL - user@company.com
#   JIRA_API_TOKEN - your API token
#   ANTHROPIC_API_KEY or other AI provider key

version: "1.0"

# Import the reusable jira-context workflow
extends:
  - defaults/jira-context.yaml

# Global AI configuration
ai_provider: anthropic
ai_model: claude-sonnet-4-20250514

steps:
  # Example 1: Basic usage - Jira-aware code review
  jira-aware-review:
    type: ai
    on_init:
      run:
        - workflow: jira-context
          with:
            text: "{{ pr.title }} {{ pr.body }}"
            custom_field_aliases:
              customfield_10001: "Story Points"
              customfield_10002: "Sprint"
              customfield_10016: "Epic Link"
              customfield_10020: "Acceptance Criteria"
              customfield_10030: "Team"
          as: jira-context

    prompt: |
      Review this pull request in the context of its linked Jira issues.

      ## Jira Context
      {{ outputs['jira-context'].jira_context_xml }}

      ## PR Information
      Title: {{ pr.title }}
      Description: {{ pr.body }}

      ## Changed Files
      {% for file in files %}
      - {{ file.filename }} (+{{ file.additions }}/-{{ file.deletions }})
      {% endfor %}

      ## Review Instructions
      1. Verify the code changes align with the Jira issue requirements
      2. Check if acceptance criteria (if any) are addressed
      3. Ensure the scope matches the story points estimation
      4. Flag any changes that seem out of scope for the ticket
      5. Suggest if the ticket should be updated based on implementation

      Provide a structured review with:
      - Alignment Score (1-10): How well does this PR address the Jira issue?
      - Missing Requirements: Any requirements from Jira not addressed
      - Scope Concerns: Any changes that seem outside the ticket scope
      - Recommendations: Suggestions for both code and Jira ticket updates

    on: [pull_request]
    tags: [review, jira]

  # Example 2: Dynamic Jira key extraction from PR body patterns
  dynamic-jira-review:
    type: ai
    on_init:
      # Use run_js to dynamically extract and process Jira keys
      run_js: |
        const text = `${pr.title || ''} ${pr.body || ''}`;

        // Check if there are any Jira keys
        const jiraKeys = text.match(/[A-Z][A-Z0-9]+-\d+/g) || [];
        if (jiraKeys.length === 0) {
          // No Jira keys found, skip the workflow
          return [];
        }

        // Return workflow invocation
        return [{
          workflow: 'jira-context',
          with: {
            text: text,
            include_comments: true,
            max_issues: 3,
            custom_field_aliases: {
              'customfield_10001': 'Story Points',
              'customfield_10002': 'Sprint',
              'customfield_10016': 'Epic Link'
            }
          },
          as: 'jira-context'
        }];

    prompt: |
      {% if outputs['jira-context'] %}
      ## Linked Jira Issues
      {{ outputs['jira-context'].jira_context_xml }}

      Review this PR considering the linked Jira context above.
      {% else %}
      No Jira issues were linked to this PR.
      Consider adding a Jira ticket reference to the PR title or description.
      {% endif %}

      ## PR Details
      Title: {{ pr.title }}

      Analyze the changes and provide feedback.

    on: [pull_request]
    tags: [review, jira, dynamic]

  # Example 3: Multi-source context enrichment
  enriched-review:
    type: ai
    on_init:
      run:
        # Fetch Jira context
        - workflow: jira-context
          with:
            text: "{{ pr.title }} {{ pr.body }}"
            custom_field_aliases:
              customfield_10001: "Story Points"
              customfield_10002: "Sprint"
          as: jira-context

        # Also fetch some external data (example tool)
        - tool: fetch-external-data
          with:
            source: config-service
          as: config-context

    prompt: |
      ## Jira Context
      {% if outputs['jira-context'].issue_count > 0 %}
      {{ outputs['jira-context'].jira_context_xml }}
      {% else %}
      No Jira issues linked to this PR.
      {% endif %}

      ## Configuration Context
      {{ outputs['config-context'] | json }}

      ## PR Information
      {{ pr.title }}

      Review the code changes with full context.

    on: [pull_request]
    tags: [review, enriched]

  # Example 4: Conditional Jira requirement check
  jira-requirement-check:
    type: command
    on_init:
      run:
        - workflow: jira-context
          with:
            text: "{{ pr.title }} {{ pr.body }}"
          as: jira-context

    exec: |
      ISSUE_COUNT={{ outputs['jira-context'].issue_count | default: 0 }}

      if [ "$ISSUE_COUNT" -eq 0 ]; then
        echo "::error::No Jira issue linked to this PR!"
        echo "Please include a Jira ticket reference (e.g., PROJ-123) in your PR title or description."
        exit 1
      fi

      echo "Found $ISSUE_COUNT linked Jira issue(s)"
      echo "Issues: {{ outputs['jira-context'].issues | map: 'key' | join: ', ' }}"

    on: [pull_request]
    tags: [validation, jira]
    fail_if: "{{ outputs['jira-context'].issue_count == 0 }}"

# Custom field aliases reference for common Jira configurations:
#
# Atlassian Cloud typical fields:
#   customfield_10001: Story Points
#   customfield_10002: Sprint
#   customfield_10014: Epic Link (varies)
#   customfield_10016: Epic Name
#   customfield_10020: Acceptance Criteria / Definition of Done
#
# To find your custom field IDs:
# 1. Open a Jira issue in your browser
# 2. Append ?expand=names,renderedFields to the URL
# 3. Or use Jira REST API: /rest/api/3/field

# Environment setup:
# export JIRA_BASE_URL="https://your-company.atlassian.net"
# export JIRA_EMAIL="your.email@company.com"
# export JIRA_API_TOKEN="your_api_token_here"
# export ANTHROPIC_API_KEY="your_anthropic_key"
