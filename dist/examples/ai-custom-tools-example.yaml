version: "1.0"

# Example: Using Custom Tools with AI Checks
# This demonstrates how to expose custom shell-based tools to AI via ephemeral SSE MCP servers

# Define custom tools that AI can use
tools:
  # Tool 1: Search for patterns in code
  grep-pattern:
    name: grep-pattern
    description: Search for specific patterns in TypeScript files
    inputSchema:
      type: object
      properties:
        pattern:
          type: string
          description: The pattern to search for (regex supported)
        files:
          type: string
          description: File glob pattern (default is *.ts)
      required: [pattern]
    exec: |
      grep -rn "{{ args.pattern }}" {{ args.files | default: "*.ts" }} 2>/dev/null || echo "No matches found"
    parseJson: false
    timeout: 5000

  # Tool 2: Count TODO comments
  count-todos:
    name: count-todos
    description: Count TODO, FIXME, and HACK comments in the codebase
    inputSchema:
      type: object
      properties:
        directory:
          type: string
          description: Directory to search (default is src/)
      required: []
    exec: |
      echo "TODO: $(grep -r "TODO" {{ args.directory | default: "src/" }} 2>/dev/null | wc -l | tr -d ' ')"
      echo "FIXME: $(grep -r "FIXME" {{ args.directory | default: "src/" }} 2>/dev/null | wc -l | tr -d ' ')"
      echo "HACK: $(grep -r "HACK" {{ args.directory | default: "src/" }} 2>/dev/null | wc -l | tr -d ' ')"
    parseJson: false
    timeout: 10000

  # Tool 3: Check for security issues
  check-secrets:
    name: check-secrets
    description: Scan for potential hardcoded secrets and API keys
    inputSchema:
      type: object
      properties:
        file:
          type: string
          description: Specific file to check (optional)
      required: []
    exec: |
      FILES="{{ args.file | default: '.' }}"
      echo "Scanning for potential secrets in: $FILES"
      grep -rn -E "(api[_-]?key|secret|password|token)\s*[:=]" $FILES 2>/dev/null | head -20 || echo "No obvious secrets found"
    parseJson: false
    timeout: 10000

  # Tool 4: List recent git changes
  git-recent-changes:
    name: git-recent-changes
    description: Get list of recently changed files
    inputSchema:
      type: object
      properties:
        count:
          type: number
          description: Number of commits to look back (default is 5)
      required: []
    exec: |
      git log -{{ args.count | default: 5 }} --name-only --pretty=format:"Commit: %h - %s" 2>/dev/null || echo "Not a git repository"
    parseJson: false
    timeout: 5000

  # Tool 5: Get file stats
  file-stats:
    name: file-stats
    description: Get statistics about a specific file
    inputSchema:
      type: object
      properties:
        filename:
          type: string
          description: The file to analyze
      required: [filename]
    exec: |
      if [ -f "{{ args.filename }}" ]; then
        echo "File: {{ args.filename }}"
        echo "Lines: $(wc -l < "{{ args.filename }}" | tr -d ' ')"
        echo "Size: $(wc -c < "{{ args.filename }}" | tr -d ' ') bytes"
        echo "Last modified: $(stat -f "%Sm" "{{ args.filename }}" 2>/dev/null || stat -c "%y" "{{ args.filename }}" 2>/dev/null)"
      else
        echo "Error: File not found - {{ args.filename }}"
      fi
    parseJson: false
    timeout: 3000

# Define AI checks that use these custom tools
steps:
  # Check 1: Security review using custom tools
  security-scan:
    type: ai
    prompt: |
      You are a security-focused code reviewer. You have access to specialized tools.

      Your mission:
      1. Use the 'check-secrets' tool to scan for hardcoded secrets
      2. Use the 'grep-pattern' tool to find unsafe function calls like eval(), exec(), or system()
      3. Report any security issues you find

      Provide a security assessment with severity levels (critical, high, medium, low).
    ai_custom_tools:
      - check-secrets
      - grep-pattern
    ai:
      provider: anthropic
      model: claude-3-5-sonnet-20241022
      debug: true
    on:
      - manual

  # Check 2: Code quality review using custom tools
  code-quality:
    type: ai
    prompt: |
      You are a code quality reviewer. You have specialized analysis tools.

      Tasks:
      1. Use 'count-todos' to get an overview of pending work
      2. Use 'git-recent-changes' to understand recent activity
      3. Use 'grep-pattern' to find console.log statements that should be removed

      Provide recommendations for improving code quality.
    ai_custom_tools:
      - count-todos
      - git-recent-changes
      - grep-pattern
    ai:
      provider: anthropic
      model: claude-3-5-sonnet-20241022
    on:
      - manual

  # Check 3: File-specific analysis
  analyze-file:
    type: ai
    prompt: |
      You are analyzing a specific file in the codebase.

      Use the 'file-stats' tool to get information about: src/index.ts
      Then use 'grep-pattern' to find all exported functions in that file.

      Provide a summary of what this file does based on your analysis.
    ai_custom_tools:
      - file-stats
      - grep-pattern
    ai:
      provider: anthropic
      model: claude-3-5-sonnet-20241022
    on:
      - manual

  # Check 4: Comprehensive review combining custom tools and MCP servers
  comprehensive-review:
    type: ai
    prompt: |
      You are performing a comprehensive code review with access to multiple tools.

      Custom tools available:
      - check-secrets: Scan for hardcoded secrets
      - count-todos: Count pending work items
      - grep-pattern: Search for patterns
      - git-recent-changes: See recent commits
      - file-stats: Get file information

      Use these tools strategically to provide a thorough review of the codebase.
      Focus on security, code quality, and technical debt.
    ai_custom_tools:
      - check-secrets
      - count-todos
      - grep-pattern
      - git-recent-changes
      - file-stats
    ai_mcp_servers:
      # You can combine custom tools with external MCP servers
      filesystem:
        command: npx
        args: ["-y", "@modelcontextprotocol/server-filesystem", "/path/to/workspace"]
    ai:
      provider: anthropic
      model: claude-3-5-sonnet-20241022
      debug: true
    on:
      - manual

# Output configuration
output:
  pr_comment:
    enabled: true
    format: markdown
    group_by: check
    collapse: false
