version: "1.0"

# Example: Using Imported Reusable Tools and Workflows with on_init
# This demonstrates how to import tools and workflows from separate files
# and use them multiple times in on_init hooks.
#
# NOTE: In production, you would use extends to import from separate files:
#
# extends:
#   - ./reusable-tools.yaml
#   - ./reusable-workflows.yaml
#
# For test compatibility, tools and workflows are shown inline below (commented out).

# NOTE: Reusable tools would be imported from reusable-tools.yaml
# In production, those tools would be available after extends.
# tools:
#   fetch-jira-issue:
#     exec: |
#       echo '{"key":"PROJ-456","summary":"Example issue",...}'
#     parseJson: true
#   fetch-external-data:
#     exec: |
#       case {{ args.source }} in
#         user-db) echo '{"source":"user-db","data":{"count":2}}' ;;
#         metrics-api) echo '{"source":"metrics-api","data":{"cpu":45}}' ;;
#       esac
#     parseJson: true

# NOTE: Reusable workflows would be imported from reusable-workflows.yaml
# workflows:
#   data-enrichment:
#     steps:
#       - id: fetch-primary
#         exec: echo '{"primary":"data"}'
#       - id: merge-results
#         exec: echo '{"enriched":true}'
#     output_mapping:
#       enriched_data: "{{ outputs['merge-results'] }}"

steps:
  # Example 1: Use multiple imported tools in on_init
  # In production: Uses fetch-jira-issue and fetch-external-data from reusable-tools.yaml
  multi-tool-preprocessing:
    type: command
    on_init:
      run:
        - tool: fetch-jira-issue
          with:
            issue_key: PROJ-456
          as: jira-data
        - tool: fetch-external-data
          with:
            source: user-db
          as: user-data
        - tool: fetch-external-data
          with:
            source: metrics-api
          as: metrics-data
    exec: |
      echo "JIRA: {{ outputs['jira-data'].summary }}"
      echo "Users: {{ outputs['user-data'].data.count }}"
      echo "Metrics: {{ outputs['metrics-data'].data.cpu }}%"

  # Example 2: Use imported workflow in on_init
  # In production: Uses data-enrichment workflow from reusable-workflows.yaml
  workflow-preprocessing:
    type: command
    on_init:
      run:
        - workflow: data-enrichment
          as: enriched
    exec: |
      echo "Enriched: {{ outputs.enriched.enriched_data.enriched }}"

  # Example 3: Chain imported tools and workflows
  # In production: Uses tools and workflows from imported files
  chain-tools-and-workflows:
    type: command
    on_init:
      run:
        - tool: fetch-external-data
          with:
            source: config-service
          as: config
        - workflow: multi-step-validation
          as: validation
        - tool: validate-data
          with:
            data: "{{ outputs.config.data }}"
          as: final-check
    exec: |
      echo "Config: {{ outputs.config.data.version }}"
      echo "Validation: {{ outputs.validation.validation_result.status }}"
      echo "Final: {{ outputs['final-check'].valid }}"

  # Example 4: Use same tool multiple times with different parameters
  # Demonstrates tool reusability across multiple invocations
  repeated-tool-usage:
    type: command
    on_init:
      run:
        - tool: fetch-external-data
          with:
            source: user-db
          as: users
        - tool: fetch-external-data
          with:
            source: config-service
          as: config
        - tool: fetch-external-data
          with:
            source: metrics-api
          as: metrics
    exec: |
      echo "Fetched from 3 sources:"
      echo "- {{ outputs.users.source }}: {{ outputs.users.data.count }} users"
      echo "- {{ outputs.config.source }}: version {{ outputs.config.data.version }}"
      echo "- {{ outputs.metrics.source }}: {{ outputs.metrics.data.cpu }}% CPU"

tests:
  defaults:
    strict: false
    fail_on_unexpected_calls: false
  fixtures: []
  cases:
    - name: multi-tool-preprocessing-test
      description: Test using multiple imported tools in on_init
      event: manual
      fixture: gh.pr_open.minimal
      mocks:
        multi-tool-preprocessing: |
          JIRA: Example issue
          Users: 2
          Metrics: 45%
      expect:
        calls:
          - step: multi-tool-preprocessing
            exactly: 1

    - name: workflow-preprocessing-test
      description: Test using imported workflow in on_init
      event: manual
      fixture: gh.pr_open.minimal
      mocks:
        workflow-preprocessing: "Enriched: true"
      expect:
        calls:
          - step: workflow-preprocessing
            exactly: 1

    - name: chain-tools-workflows-test
      description: Test chaining imported tools and workflows
      event: manual
      fixture: gh.pr_open.minimal
      mocks:
        chain-tools-and-workflows: |
          Config: 1.2.3
          Validation: approved
          Final: true
      expect:
        calls:
          - step: chain-tools-and-workflows
            exactly: 1

    - name: repeated-tool-test
      description: Test using same tool multiple times
      event: manual
      fixture: gh.pr_open.minimal
      mocks:
        repeated-tool-usage: |
          Fetched from 3 sources:
          - user-db: 2 users
          - config-service: version 1.2.3
          - metrics-api: 45% CPU
      expect:
        calls:
          - step: repeated-tool-usage
            exactly: 1
