{"version":3,"sources":["../../src/slack/markdown.ts"],"sourcesContent":["// Lightweight Markdown → Slack mrkdwn formatter.\n// The goal is to make common Markdown output from AI steps look natural in Slack\n// without pulling in a full Markdown parser.\n//\n// Supported conversions:\n// - # Header / ## Header  → *Header* (bold with visual separation)\n// - **bold** / __bold__   → *bold*\n// - [label](url)          → <url|label>\n// - ![alt](url)           → <url|alt>\n// - *italic* (inline)     → _italic_\n// - ```mermaid blocks     → rendered to PNG and uploaded to Slack\n//\n// Everything else is passed through unchanged; Slack will still render many\n// Markdown-like constructs (lists, code fences, etc.) natively.\n\nimport { spawn } from 'child_process';\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport * as os from 'os';\n\n/**\n * Represents an extracted mermaid diagram\n */\nexport interface MermaidDiagram {\n  /** The full match including ```mermaid and ``` */\n  fullMatch: string;\n  /** The mermaid code content */\n  code: string;\n  /** Start index in the original text */\n  startIndex: number;\n  /** End index in the original text */\n  endIndex: number;\n}\n\n/**\n * Extract all mermaid code blocks from text\n */\nexport function extractMermaidDiagrams(text: string): MermaidDiagram[] {\n  const diagrams: MermaidDiagram[] = [];\n  // Match ```mermaid followed by newline, content, and closing ```\n  const regex = /```mermaid\\s*\\n([\\s\\S]*?)```/g;\n  let match;\n  while ((match = regex.exec(text)) !== null) {\n    diagrams.push({\n      fullMatch: match[0],\n      code: match[1].trim(),\n      startIndex: match.index,\n      endIndex: match.index + match[0].length,\n    });\n  }\n  return diagrams;\n}\n\n/**\n * Render a mermaid diagram to PNG using mmdc CLI (@mermaid-js/mermaid-cli).\n *\n * Requirements:\n * - Node.js and npx must be available in PATH\n * - Network access on first run (npx downloads the package)\n * - Puppeteer/Chromium dependencies (mermaid-cli uses headless browser)\n *\n * On Linux, you may need to install chromium dependencies:\n *   apt-get install -y chromium-browser libatk-bridge2.0-0 libgtk-3-0\n *\n * On Docker/CI, consider using a base image with puppeteer support or\n * pre-installing @mermaid-js/mermaid-cli globally.\n *\n * @param mermaidCode The mermaid diagram code\n * @returns Buffer containing PNG data, or null if rendering failed\n */\nexport async function renderMermaidToPng(mermaidCode: string): Promise<Buffer | null> {\n  // Create temp files for input and output\n  const tmpDir = os.tmpdir();\n  const inputFile = path.join(\n    tmpDir,\n    `mermaid-${Date.now()}-${Math.random().toString(36).slice(2)}.mmd`\n  );\n  const outputFile = path.join(\n    tmpDir,\n    `mermaid-${Date.now()}-${Math.random().toString(36).slice(2)}.png`\n  );\n\n  try {\n    // Write mermaid code to temp file\n    fs.writeFileSync(inputFile, mermaidCode, 'utf-8');\n\n    // Detect system chromium for puppeteer (mermaid-cli dependency)\n    // Without this, puppeteer may hang trying to download its own chromium\n    const chromiumPaths = [\n      '/usr/bin/chromium',\n      '/usr/bin/chromium-browser',\n      '/usr/bin/google-chrome',\n      '/usr/bin/chrome',\n    ];\n    let chromiumPath: string | undefined;\n    for (const p of chromiumPaths) {\n      if (fs.existsSync(p)) {\n        chromiumPath = p;\n        break;\n      }\n    }\n\n    // Build environment with chromium path if found\n    const env = { ...process.env };\n    if (chromiumPath) {\n      env.PUPPETEER_EXECUTABLE_PATH = chromiumPath;\n    }\n\n    // Run mmdc to render PNG\n    const result = await new Promise<{ success: boolean; error?: string }>(resolve => {\n      const proc = spawn(\n        'npx',\n        [\n          '--yes',\n          '@mermaid-js/mermaid-cli',\n          '-i',\n          inputFile,\n          '-o',\n          outputFile,\n          '-e',\n          'png',\n          '-b',\n          'white',\n          '-w',\n          '1200',\n        ],\n        {\n          timeout: 60000, // 60 second timeout (first run may download packages)\n          stdio: ['pipe', 'pipe', 'pipe'],\n          env,\n        }\n      );\n\n      let stderr = '';\n      proc.stderr?.on('data', data => {\n        stderr += data.toString();\n      });\n\n      proc.on('close', code => {\n        if (code === 0) {\n          resolve({ success: true });\n        } else {\n          resolve({ success: false, error: stderr || `Exit code ${code}` });\n        }\n      });\n\n      proc.on('error', err => {\n        resolve({ success: false, error: err.message });\n      });\n    });\n\n    if (!result.success) {\n      console.warn(`Mermaid rendering failed: ${result.error}`);\n      return null;\n    }\n\n    // Read the output PNG\n    if (!fs.existsSync(outputFile)) {\n      console.warn('Mermaid output file not created');\n      return null;\n    }\n\n    const pngBuffer = fs.readFileSync(outputFile);\n    return pngBuffer;\n  } catch (e) {\n    console.warn(`Mermaid rendering error: ${e instanceof Error ? e.message : String(e)}`);\n    return null;\n  } finally {\n    // Cleanup temp files\n    try {\n      if (fs.existsSync(inputFile)) fs.unlinkSync(inputFile);\n      if (fs.existsSync(outputFile)) fs.unlinkSync(outputFile);\n    } catch {\n      // Ignore cleanup errors\n    }\n  }\n}\n\n/**\n * Replace mermaid blocks in text with a placeholder message\n * @param text Original text\n * @param diagrams Extracted diagrams\n * @param replacement Text to replace each diagram with (or a function that returns replacement for each index)\n */\nexport function replaceMermaidBlocks(\n  text: string,\n  diagrams: MermaidDiagram[],\n  replacement: string | ((index: number) => string) = '_(See diagram above)_'\n): string {\n  if (diagrams.length === 0) return text;\n\n  // Sort by start index descending to replace from end to start (preserves indices)\n  const sorted = [...diagrams].sort((a, b) => b.startIndex - a.startIndex);\n\n  let result = text;\n  sorted.forEach((diagram, sortedIndex) => {\n    // Calculate original index (since we sorted in reverse)\n    const originalIndex = diagrams.length - 1 - sortedIndex;\n    const rep = typeof replacement === 'function' ? replacement(originalIndex) : replacement;\n    result = result.slice(0, diagram.startIndex) + rep + result.slice(diagram.endIndex);\n  });\n\n  return result;\n}\n\nexport function markdownToSlack(text: string): string {\n  if (!text || typeof text !== 'string') return '';\n\n  let out = text;\n\n  // Images: ![alt](url) → <url|alt>\n  // We intentionally keep only the URL + alt text; Slack will usually unfurl.\n  out = out.replace(\n    /!\\[([^\\]]*)\\]\\(([^)\\s]+)(?:\\s+\"[^\"]*\")?\\)/g,\n    (_m, alt: string, url: string) => `<${url}|${alt || 'image'}>`\n  );\n\n  // Links: [label](url) → <url|label>\n  out = out.replace(\n    /\\[([^\\]]+)\\]\\(([^)\\s]+)(?:\\s+\"[^\"]*\")?\\)/g,\n    (_m, label: string, url: string) => `<${url}|${label}>`\n  );\n\n  // Bold: **text** or __text__ → *text*\n  out = out.replace(/\\*\\*([^*]+)\\*\\*/g, (_m, inner: string) => `*${inner}*`);\n  out = out.replace(/__([^_]+)__/g, (_m, inner: string) => `*${inner}*`);\n\n  // Process lines for headers and bullet lists.\n  // Slack's mrkdwn handles \"•\" bullets more naturally than raw \"-\" Markdown.\n  const lines = out.split(/\\r?\\n/);\n  let inCodeBlock = false;\n  for (let i = 0; i < lines.length; i++) {\n    const line = lines[i];\n    const trimmed = line.trimStart();\n    // Track fenced code blocks and avoid rewriting inside them\n    if (/^```/.test(trimmed)) {\n      inCodeBlock = !inCodeBlock;\n      continue;\n    }\n    if (inCodeBlock) continue;\n\n    // Headers: # Header → *Header* (Slack doesn't have native headers)\n    // Match 1-6 # at start of line, followed by space and text\n    const headerMatch = /^(#{1,6})\\s+(.+)$/.exec(trimmed);\n    if (headerMatch) {\n      const [, hashes, headerText] = headerMatch;\n      // For h1/h2, add extra emphasis with newline before (if not first line\n      // and previous line is not empty/header/code-fence)\n      const prevLine = i > 0 ? lines[i - 1].trim() : '';\n      const prevIsHeaderOrFence =\n        /^#{1,6}\\s+/.test(prevLine) || /^\\*[^*]+\\*$/.test(prevLine) || /^```/.test(prevLine);\n      if (hashes.length <= 2 && i > 0 && prevLine !== '' && !prevIsHeaderOrFence) {\n        lines[i] = `\\n*${headerText.trim()}*`;\n      } else {\n        lines[i] = `*${headerText.trim()}*`;\n      }\n      continue;\n    }\n\n    // Bullet lists: \"- item\" or \"* item\" → \"• item\" (preserve indentation)\n    const bulletMatch = /^(\\s*)([-*])\\s+(.+)$/.exec(line);\n    if (bulletMatch) {\n      const [, indent, , rest] = bulletMatch;\n      lines[i] = `${indent}• ${rest}`;\n    }\n  }\n  out = lines.join('\\n');\n\n  return out;\n}\n\n/**\n * Represents an extracted file section delimited by --- filename.ext ---\n */\nexport interface FileSection {\n  /** Full match including delimiter(s) and content */\n  fullMatch: string;\n  /** Extracted filename (e.g., \"report.csv\") */\n  filename: string;\n  /** Content after the opening delimiter (trimmed) */\n  content: string;\n  /** Start index in the original text */\n  startIndex: number;\n  /** End index in the original text */\n  endIndex: number;\n}\n\n/**\n * Extract all file sections delimited by --- filename.ext --- from text.\n *\n * A section starts at a `--- filename.ext ---` line. It ends at:\n *   1. A closing delimiter with the same filename (optional, backward-compatible)\n *   2. The next `--- other.ext ---` delimiter (starts a new section)\n *   3. End of text\n */\nexport function extractFileSections(text: string): FileSection[] {\n  const sections: FileSection[] = [];\n\n  // Find all --- filename.ext --- delimiter lines\n  const delimRegex = /^--- ([\\w][\\w.\\-]*\\.\\w+) ---$/gm;\n  const delimiters: { filename: string; start: number; end: number }[] = [];\n  let m;\n  while ((m = delimRegex.exec(text)) !== null) {\n    delimiters.push({\n      filename: m[1],\n      start: m.index,\n      end: m.index + m[0].length,\n    });\n  }\n\n  if (delimiters.length === 0) return sections;\n\n  for (let i = 0; i < delimiters.length; i++) {\n    const open = delimiters[i];\n\n    // Content starts after the newline following the opening delimiter\n    const contentStart =\n      open.end < text.length && text[open.end] === '\\n' ? open.end + 1 : open.end;\n\n    // Section extends to the next delimiter or end of text\n    const sectionEnd = i + 1 < delimiters.length ? delimiters[i + 1].start : text.length;\n    const content = text.substring(contentStart, sectionEnd).trim();\n    if (content.length > 0) {\n      sections.push({\n        fullMatch: text.substring(open.start, sectionEnd),\n        filename: open.filename,\n        content,\n        startIndex: open.start,\n        endIndex: sectionEnd,\n      });\n    }\n  }\n\n  return sections;\n}\n\n/**\n * Replace file sections in text with placeholder messages.\n * Uses back-to-front replacement to preserve indices (same as replaceMermaidBlocks).\n */\nexport function replaceFileSections(\n  text: string,\n  sections: FileSection[],\n  replacement: string | ((index: number) => string) = idx =>\n    `_(See file: ${sections[idx].filename} above)_`\n): string {\n  if (sections.length === 0) return text;\n\n  const sorted = [...sections].sort((a, b) => b.startIndex - a.startIndex);\n\n  let result = text;\n  sorted.forEach((section, sortedIndex) => {\n    const originalIndex = sections.length - 1 - sortedIndex;\n    const rep = typeof replacement === 'function' ? replacement(originalIndex) : replacement;\n    result = result.slice(0, section.startIndex) + rep + result.slice(section.endIndex);\n  });\n\n  return result;\n}\n\nexport function formatSlackText(text: string): string {\n  return markdownToSlack(text);\n}\n"],"mappings":"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","names":[]}