{"version":3,"sources":["../../src/utils/sandbox.ts"],"sourcesContent":["import Sandbox from '@nyariv/sandboxjs';\n\n/**\n * Centralized helpers for creating and using SandboxJS instances consistently\n * across providers. The goal is to have one place to define allowed globals\n * and prototype whitelists, and to offer a small helper to inject a `log`\n * utility inside user-provided JS snippets.\n */\n\nexport interface CompileOptions {\n  injectLog?: boolean;\n  logPrefix?: string;\n  /** When true, wrap the code in a function and `return` its result */\n  wrapFunction?: boolean;\n}\n\nexport interface JsSyntaxValidationResult {\n  valid: boolean;\n  error?: string;\n}\n\n/**\n * Validate JavaScript syntax without executing it.\n * Uses the sandbox's compile method to check for syntax errors.\n * Returns validation result with error message if invalid.\n */\nexport function validateJsSyntax(code: string): JsSyntaxValidationResult {\n  if (!code || typeof code !== 'string') {\n    return { valid: false, error: 'Code must be a non-empty string' };\n  }\n\n  const trimmed = code.trim();\n  if (trimmed.length === 0) {\n    return { valid: false, error: 'Code cannot be empty' };\n  }\n\n  // Create a minimal sandbox instance for syntax checking\n  const sandbox = createSecureSandbox();\n\n  // Wrap code similar to compileAndRun to catch the same syntax issues\n  const looksLikeBlock = /\\breturn\\b/.test(trimmed) || /;/.test(trimmed) || /\\n/.test(trimmed);\n  const looksLikeIife = /\\)\\s*\\(\\s*\\)\\s*;?$/.test(trimmed);\n  const body = looksLikeBlock\n    ? looksLikeIife\n      ? `return (\\n${trimmed}\\n);\\n`\n      : `return (() => {\\n${trimmed}\\n})();\\n`\n    : `return (\\n${trimmed}\\n);\\n`;\n\n  // For syntax validation, we just need to ensure 'log' is defined so code using it parses correctly\n  // No need for unique IDs since validation creates a fresh sandbox and only compiles (no execution)\n  const header = `var log = function() {};\\n`;\n  const fullCode = `${header}${body}`;\n\n  try {\n    sandbox.compile(fullCode);\n    return { valid: true };\n  } catch (e) {\n    const msg = e instanceof Error ? e.message : String(e);\n    return { valid: false, error: msg };\n  }\n}\n\n/**\n * Create a hardened Sandbox with a consistent set of globals and prototype\n * whitelists. This is a superset of the sets previously used by individual\n * providers, kept intentionally minimal and side‑effect free.\n */\nexport function createSecureSandbox(): Sandbox {\n  const globals = {\n    ...Sandbox.SAFE_GLOBALS,\n    Math,\n    JSON,\n    // Provide console with limited surface. Use trampolines so that any test\n    // spies (e.g., jest.spyOn(console, 'log')) see calls made inside the sandbox.\n    console: {\n      log: (...args: unknown[]) => {\n        try {\n          (console as any).log(...args);\n        } catch {}\n      },\n      warn: (...args: unknown[]) => {\n        try {\n          (console as any).warn(...args);\n        } catch {}\n      },\n      error: (...args: unknown[]) => {\n        try {\n          (console as any).error(...args);\n        } catch {}\n      },\n    },\n  } as Record<string, unknown>;\n\n  const prototypeWhitelist = new Map(Sandbox.SAFE_PROTOTYPES);\n\n  // Arrays — union of methods used around the codebase\n  const arrayMethods = new Set<string>([\n    // Query/iteration\n    'some',\n    'every',\n    'filter',\n    'map',\n    'reduce',\n    'reduceRight',\n    'find',\n    'findIndex',\n    'findLast',\n    'findLastIndex',\n    'includes',\n    'indexOf',\n    'lastIndexOf',\n    'keys',\n    'values',\n    'entries',\n    'forEach',\n    // Non‑mutating ES2023 additions\n    'toReversed',\n    'toSorted',\n    'toSpliced',\n    'with',\n    'at',\n    // Mutators and common ops\n    'slice',\n    'concat',\n    'join',\n    'push',\n    'pop',\n    'shift',\n    'unshift',\n    'sort',\n    'reverse',\n    'copyWithin',\n    'fill',\n    // Flattening\n    'flat',\n    'flatMap',\n    // Meta\n    'length',\n  ]);\n  prototypeWhitelist.set(Array.prototype, arrayMethods);\n\n  // Strings — allow common, safe manipulation helpers\n  const stringMethods = new Set<string>([\n    'toLowerCase',\n    'toUpperCase',\n    'includes',\n    'indexOf',\n    'lastIndexOf',\n    'startsWith',\n    'endsWith',\n    'slice',\n    'substring',\n    'substr',\n    'trim',\n    'trimStart',\n    'trimEnd',\n    'split',\n    'replace',\n    'replaceAll',\n    'match',\n    'matchAll',\n    'charAt',\n    'charCodeAt',\n    'codePointAt',\n    'normalize',\n    'repeat',\n    'padStart',\n    'padEnd',\n    'at',\n    'length',\n  ]);\n  prototypeWhitelist.set(String.prototype, stringMethods);\n\n  // Objects — keep to basic safe operations\n  const objectMethods = new Set<string>([\n    'hasOwnProperty',\n    'propertyIsEnumerable',\n    'toString',\n    'valueOf',\n  ]);\n  prototypeWhitelist.set(Object.prototype, objectMethods);\n\n  // Keep native constructors from SAFE_GLOBALS; rely on prototype whitelists above.\n\n  // Maps and Sets — allow common, safe operations\n  const mapMethods = new Set<string>([\n    'get',\n    'set',\n    'has',\n    'delete',\n    'entries',\n    'keys',\n    'values',\n    'forEach',\n  ]);\n  // @ts-ignore - sandbox typings accept Map.prototype as a key\n  prototypeWhitelist.set((Map as any).prototype, mapMethods);\n\n  const setMethods = new Set<string>([\n    'add',\n    'has',\n    'delete',\n    'entries',\n    'keys',\n    'values',\n    'forEach',\n  ]);\n  // @ts-ignore\n  prototypeWhitelist.set((Set as any).prototype, setMethods);\n\n  // Date and RegExp — read‑only helpers\n  const dateMethods = new Set<string>(['toISOString', 'toJSON', 'getTime']);\n  // @ts-ignore\n  prototypeWhitelist.set((Date as any).prototype, dateMethods);\n\n  const regexpMethods = new Set<string>(['test', 'exec']);\n  // @ts-ignore\n  prototypeWhitelist.set((RegExp as any).prototype, regexpMethods);\n\n  return new Sandbox({ globals, prototypeWhitelist });\n}\n\n/**\n * Compile and execute user-provided JS inside the sandbox with optional\n * helper injection. By default, code is wrapped in a function to keep the\n * global scope clean.\n */\nexport function compileAndRun<T = unknown>(\n  sandbox: Sandbox,\n  userCode: string,\n  scope: Record<string, unknown>,\n  opts: CompileOptions = { injectLog: true, wrapFunction: true, logPrefix: '[sandbox]' }\n): T {\n  const inject = opts?.injectLog === true;\n  let safePrefix = String(opts?.logPrefix ?? '[sandbox]');\n  // Sanitize prefix aggressively: drop control chars and risky tokens, limit length\n  safePrefix = safePrefix\n    .replace(/[\\r\\n\\t\\0]/g, '')\n    .replace(/[`$\\\\]/g, '') // strip backticks, dollar (template) and backslashes\n    .replace(/\\$\\{/g, '') // remove template openings if present\n    .slice(0, 64);\n  // Inject log function through scope to avoid \"already declared\" errors\n  // when multiple sandbox executions run in parallel with shared global state.\n  // Only add log when injectLog is true - when false, user code may declare its own log.\n  const scopeWithLog = inject\n    ? {\n        ...scope,\n        log: (...args: unknown[]) => {\n          try {\n            console.log(safePrefix, ...args);\n          } catch {}\n        },\n      }\n    : scope;\n  // No header needed - log is passed through scope\n  const header = '';\n  // When wrapping, execute user code inside an IIFE and return its value.\n  // This reliably captures the value of the last expression or any explicit\n  // return statements inside the script, without requiring the caller to\n  // manually `return` at top level.\n  // Wrapper heuristic:\n  // - If the snippet contains an explicit `return`, semicolons or newlines (likely a block),\n  //   run it inside an IIFE so `return` works:  (() => { code })()\n  // - Otherwise treat it as a pure expression and return its value directly.\n  const src = String(userCode);\n  const looksLikeBlock = /\\breturn\\b/.test(src) || /;/.test(src) || /\\n/.test(src);\n  // Heuristic: if the snippet itself looks like an IIFE/callable expression\n  // (e.g., `(() => { ... })()` or `(function(){ ... })()`), return its value\n  // directly to avoid swallowing the result by nesting it inside another block.\n  const looksLikeIife = /\\)\\s*\\(\\s*\\)\\s*;?$/.test(src.trim());\n  // Default wrapFunction to true if not explicitly set to false\n  const shouldWrap = opts.wrapFunction !== false;\n  const body = shouldWrap\n    ? looksLikeBlock\n      ? looksLikeIife\n        ? `return (\\n${src}\\n);\\n`\n        : `return (() => {\\n${src}\\n})();\\n`\n      : `return (\\n${src}\\n);\\n`\n    : `${src}`;\n  const code = `${header}${body}`;\n\n  // Create code preview for error messages (first 100 chars, single line)\n  const codePreview = src.replace(/\\s+/g, ' ').trim().slice(0, 100);\n  const contextInfo = safePrefix !== '[sandbox]' ? ` [${safePrefix}]` : '';\n\n  let exec: ReturnType<typeof sandbox.compile>;\n  try {\n    exec = sandbox.compile(code);\n  } catch (e) {\n    const msg = e instanceof Error ? e.message : String(e);\n    throw new Error(`sandbox_compile_error${contextInfo}: ${msg} | code: ${codePreview}`);\n  }\n\n  let out: any;\n  try {\n    out = exec(scopeWithLog);\n  } catch (e) {\n    const msg = e instanceof Error ? e.message : String(e);\n    throw new Error(`sandbox_execution_error${contextInfo}: ${msg} | code: ${codePreview}`);\n  }\n\n  if (out && typeof out.run === 'function') {\n    try {\n      return out.run();\n    } catch (e) {\n      const msg = e instanceof Error ? e.message : String(e);\n      throw new Error(`sandbox_runner_error${contextInfo}: ${msg} | code: ${codePreview}`);\n    }\n  }\n  return out as T;\n}\n"],"mappings":"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","names":[]}