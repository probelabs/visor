{"version":3,"sources":["../../src/slack/prompt-state.ts"],"sourcesContent":["import { logger } from '../logger';\n\nexport interface WaitingPromptInfo {\n  checkName: string;\n  prompt: string;\n  timestamp: number;\n  channel: string;\n  threadTs: string;\n  promptMessageTs?: string;\n  snapshotPath?: string;\n  promptsPosted?: number; // how many prompts we posted into this thread\n  context?: Record<string, unknown>;\n}\n\nexport class PromptStateManager {\n  private waiting = new Map<string, WaitingPromptInfo>(); // key: `${channel}:${threadTs}`\n  private ttlMs: number;\n  private timer?: NodeJS.Timeout;\n  private firstMessage = new Map<string, { text: string; consumed: boolean }>();\n  private summaryTs = new Map<string, Map<string, string>>(); // key: threadKey -> group -> ts\n\n  constructor(ttlMs: number = 60 * 60 * 1000) {\n    this.ttlMs = ttlMs;\n    this.startCleanup();\n  }\n\n  private key(channel: string, threadTs: string): string {\n    return `${channel}:${threadTs}`;\n  }\n\n  setWaiting(\n    channel: string,\n    threadTs: string,\n    info: Omit<WaitingPromptInfo, 'timestamp' | 'channel' | 'threadTs'>\n  ) {\n    const key = this.key(channel, threadTs);\n    const value: WaitingPromptInfo = { ...info, timestamp: Date.now(), channel, threadTs };\n    this.waiting.set(key, value);\n    try {\n      logger.info(\n        `[prompt-state] waiting set for ${key} (check=${info.checkName}, prompt=\"${info.prompt.substring(\n          0,\n          60\n        )}â€¦\")`\n      );\n    } catch {}\n  }\n\n  getWaiting(channel: string, threadTs: string): WaitingPromptInfo | undefined {\n    const key = this.key(channel, threadTs);\n    const info = this.waiting.get(key);\n    if (!info) return undefined;\n    const age = Date.now() - info.timestamp;\n    if (age > this.ttlMs) {\n      this.waiting.delete(key);\n      try {\n        logger.warn(`[prompt-state] expired ${key} (age=${Math.round(age / 1000)}s)`);\n      } catch {}\n      return undefined;\n    }\n    return info;\n  }\n\n  clear(channel: string, threadTs: string): boolean {\n    const key = this.key(channel, threadTs);\n    const had = this.waiting.delete(key);\n    if (had) {\n      try {\n        logger.info(`[prompt-state] cleared ${key}`);\n      } catch {}\n    }\n    return had;\n  }\n\n  /** Merge updates into an existing waiting entry */\n  update(\n    channel: string,\n    threadTs: string,\n    patch: Partial<WaitingPromptInfo>\n  ): WaitingPromptInfo | undefined {\n    const key = this.key(channel, threadTs);\n    const prev = this.waiting.get(key);\n    if (!prev) return undefined;\n    const next = { ...prev, ...patch } as WaitingPromptInfo;\n    this.waiting.set(key, next);\n    try {\n      if (patch.snapshotPath) {\n        logger.info(`[prompt-state] snapshotPath set for ${key}`);\n      }\n    } catch {}\n    return next;\n  }\n\n  // First message capture helpers\n  setFirstMessage(channel: string, threadTs: string, text: string): void {\n    const key = this.key(channel, threadTs);\n    if (!text || !text.trim()) return;\n    if (!this.firstMessage.has(key)) {\n      this.firstMessage.set(key, { text, consumed: false });\n    }\n  }\n  consumeFirstMessage(channel: string, threadTs: string): string | undefined {\n    const key = this.key(channel, threadTs);\n    const entry = this.firstMessage.get(key);\n    if (entry && !entry.consumed) {\n      entry.consumed = true;\n      this.firstMessage.set(key, entry);\n      return entry.text;\n    }\n    return undefined;\n  }\n  hasUnconsumedFirstMessage(channel: string, threadTs: string): boolean {\n    const key = this.key(channel, threadTs);\n    const e = this.firstMessage.get(key);\n    return !!(e && !e.consumed && e.text && e.text.trim());\n  }\n\n  private startCleanup(intervalMs: number = 5 * 60 * 1000) {\n    if (this.timer) clearInterval(this.timer);\n    this.timer = setInterval(() => this.cleanup(), intervalMs);\n    if (this.timer.unref) this.timer.unref();\n  }\n\n  private cleanup(): number {\n    const now = Date.now();\n    let removed = 0;\n    for (const [key, info] of this.waiting.entries()) {\n      if (now - info.timestamp > this.ttlMs) {\n        this.waiting.delete(key);\n        removed++;\n      }\n    }\n    if (removed) {\n      try {\n        logger.info(`[prompt-state] cleanup removed ${removed} entries`);\n      } catch {}\n    }\n    return removed;\n  }\n}\n\nlet __promptState: PromptStateManager | undefined;\nexport function getPromptStateManager(ttlMs?: number): PromptStateManager {\n  if (!__promptState) __promptState = new PromptStateManager(ttlMs);\n  return __promptState;\n}\n\nexport function resetPromptStateManager(): void {\n  __promptState = undefined;\n}\n"],"mappings":"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","names":[]}