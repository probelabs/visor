{"version":3,"sources":["../../src/frontends/ndjson-sink.ts"],"sourcesContent":["import type { Frontend, FrontendContext } from './host';\nimport fs from 'fs';\nimport path from 'path';\n\ntype SinkConfig = { file?: string };\n\nexport class NdjsonSink implements Frontend {\n  public readonly name = 'ndjson-sink';\n  private cfg: SinkConfig;\n  private unsub?: { unsubscribe(): void };\n  private filePath?: string;\n\n  constructor(config?: unknown) {\n    this.cfg = (config as SinkConfig) || {};\n  }\n\n  start(ctx: FrontendContext): void {\n    this.filePath = this.resolveFile(this.cfg.file || '.visor-events.ndjson');\n    ctx.logger.info(`[ndjson-sink] Writing events to ${this.filePath}`);\n    // Subscribe to all events\n    this.unsub = ctx.eventBus.onAny(async (envelope: any) => {\n      try {\n        const line = JSON.stringify({\n          id: (envelope && envelope.id) || undefined,\n          ts: new Date().toISOString(),\n          runId: ctx.run.runId,\n          payload: (envelope && envelope.payload) || envelope,\n          safe: true,\n        });\n        await fs.promises.appendFile(this.filePath!, line + '\\n');\n      } catch (err) {\n        ctx.logger.error('[ndjson-sink] Failed to write event:', err);\n      }\n    });\n  }\n\n  stop(): void {\n    this.unsub?.unsubscribe();\n    this.unsub = undefined;\n  }\n\n  private resolveFile(p: string): string {\n    if (path.isAbsolute(p)) return p;\n    return path.join(process.cwd(), p);\n  }\n}\n"],"mappings":";;;AACA,OAAO,QAAQ;AACf,OAAO,UAAU;AAIV,IAAM,aAAN,MAAqC;AAAA,EAC1B,OAAO;AAAA,EACf;AAAA,EACA;AAAA,EACA;AAAA,EAER,YAAY,QAAkB;AAC5B,SAAK,MAAO,UAAyB,CAAC;AAAA,EACxC;AAAA,EAEA,MAAM,KAA4B;AAChC,SAAK,WAAW,KAAK,YAAY,KAAK,IAAI,QAAQ,sBAAsB;AACxE,QAAI,OAAO,KAAK,mCAAmC,KAAK,QAAQ,EAAE;AAElE,SAAK,QAAQ,IAAI,SAAS,MAAM,OAAO,aAAkB;AACvD,UAAI;AACF,cAAM,OAAO,KAAK,UAAU;AAAA,UAC1B,IAAK,YAAY,SAAS,MAAO;AAAA,UACjC,KAAI,oBAAI,KAAK,GAAE,YAAY;AAAA,UAC3B,OAAO,IAAI,IAAI;AAAA,UACf,SAAU,YAAY,SAAS,WAAY;AAAA,UAC3C,MAAM;AAAA,QACR,CAAC;AACD,cAAM,GAAG,SAAS,WAAW,KAAK,UAAW,OAAO,IAAI;AAAA,MAC1D,SAAS,KAAK;AACZ,YAAI,OAAO,MAAM,wCAAwC,GAAG;AAAA,MAC9D;AAAA,IACF,CAAC;AAAA,EACH;AAAA,EAEA,OAAa;AACX,SAAK,OAAO,YAAY;AACxB,SAAK,QAAQ;AAAA,EACf;AAAA,EAEQ,YAAY,GAAmB;AACrC,QAAI,KAAK,WAAW,CAAC,EAAG,QAAO;AAC/B,WAAO,KAAK,KAAK,QAAQ,IAAI,GAAG,CAAC;AAAA,EACnC;AACF;","names":[]}