{"version":3,"sources":["../../src/frontends/ndjson-sink.ts"],"sourcesContent":["import type { Frontend, FrontendContext } from './host';\nimport fs from 'fs';\nimport path from 'path';\n\ntype SinkConfig = { file?: string };\n\nexport class NdjsonSink implements Frontend {\n  public readonly name = 'ndjson-sink';\n  private cfg: SinkConfig;\n  private unsub?: { unsubscribe(): void };\n  private filePath?: string;\n\n  constructor(config?: unknown) {\n    this.cfg = (config as SinkConfig) || {};\n  }\n\n  start(ctx: FrontendContext): void {\n    this.filePath = this.resolveFile(this.cfg.file || '.visor-events.ndjson');\n    ctx.logger.info(`[ndjson-sink] Writing events to ${this.filePath}`);\n    // Subscribe to all events\n    this.unsub = ctx.eventBus.onAny(async (envelope: any) => {\n      try {\n        const line = JSON.stringify({\n          id: (envelope && envelope.id) || undefined,\n          ts: new Date().toISOString(),\n          runId: ctx.run.runId,\n          payload: (envelope && envelope.payload) || envelope,\n          safe: true,\n        });\n        await fs.promises.appendFile(this.filePath!, line + '\\n');\n      } catch (err) {\n        ctx.logger.error('[ndjson-sink] Failed to write event:', err);\n      }\n    });\n  }\n\n  stop(): void {\n    this.unsub?.unsubscribe();\n    this.unsub = undefined;\n  }\n\n  private resolveFile(p: string): string {\n    if (path.isAbsolute(p)) return p;\n    return path.join(process.cwd(), p);\n  }\n}\n"],"mappings":";;;;;AACA,OAAO,QAAQ;AACf,OAAO,UAAU;AAFjB,IAMa;AANb;AAAA;AAMO,IAAM,aAAN,MAAqC;AAAA,MAC1B,OAAO;AAAA,MACf;AAAA,MACA;AAAA,MACA;AAAA,MAER,YAAY,QAAkB;AAC5B,aAAK,MAAO,UAAyB,CAAC;AAAA,MACxC;AAAA,MAEA,MAAM,KAA4B;AAChC,aAAK,WAAW,KAAK,YAAY,KAAK,IAAI,QAAQ,sBAAsB;AACxE,YAAI,OAAO,KAAK,mCAAmC,KAAK,QAAQ,EAAE;AAElE,aAAK,QAAQ,IAAI,SAAS,MAAM,OAAO,aAAkB;AACvD,cAAI;AACF,kBAAM,OAAO,KAAK,UAAU;AAAA,cAC1B,IAAK,YAAY,SAAS,MAAO;AAAA,cACjC,KAAI,oBAAI,KAAK,GAAE,YAAY;AAAA,cAC3B,OAAO,IAAI,IAAI;AAAA,cACf,SAAU,YAAY,SAAS,WAAY;AAAA,cAC3C,MAAM;AAAA,YACR,CAAC;AACD,kBAAM,GAAG,SAAS,WAAW,KAAK,UAAW,OAAO,IAAI;AAAA,UAC1D,SAAS,KAAK;AACZ,gBAAI,OAAO,MAAM,wCAAwC,GAAG;AAAA,UAC9D;AAAA,QACF,CAAC;AAAA,MACH;AAAA,MAEA,OAAa;AACX,aAAK,OAAO,YAAY;AACxB,aAAK,QAAQ;AAAA,MACf;AAAA,MAEQ,YAAY,GAAmB;AACrC,YAAI,KAAK,WAAW,CAAC,EAAG,QAAO;AAC/B,eAAO,KAAK,KAAK,QAAQ,IAAI,GAAG,CAAC;AAAA,MACnC;AAAA,IACF;AAAA;AAAA;","names":[]}