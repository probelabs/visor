{"version":3,"sources":["../../src/event-bus/event-bus.ts"],"sourcesContent":["import type { EventEnvelope, AnyEvent } from './types';\n\nexport type EventHandler<T = AnyEvent> = (event: T | EventEnvelope<T>) => void | Promise<void>;\n\nexport interface Subscription {\n  unsubscribe(): void;\n}\n\nexport class EventBus {\n  private handlers: Map<string, Set<EventHandler>> = new Map();\n  private anyHandlers: Set<EventHandler> = new Set();\n\n  on<T = AnyEvent>(eventType: string, handler: EventHandler<T>): Subscription {\n    const set = this.handlers.get(eventType) || new Set<EventHandler>();\n    set.add(handler);\n    this.handlers.set(eventType, set);\n    return {\n      unsubscribe: () => {\n        set.delete(handler);\n      },\n    };\n  }\n\n  onAny(handler: EventHandler): Subscription {\n    this.anyHandlers.add(handler);\n    return { unsubscribe: () => this.anyHandlers.delete(handler) };\n  }\n\n  async emit(event: AnyEvent | EventEnvelope): Promise<void> {\n    const type = (event as any)?.payload?.type ?? (event as any)?.type ?? 'unknown';\n    const list: EventHandler[] = [\n      ...Array.from(this.anyHandlers),\n      ...Array.from(this.handlers.get(type) || []),\n    ];\n    for (const h of list) {\n      // Run sequentially to keep ordering guarantees per emit call\n      // Handlers themselves should fan out if they need concurrency\n      await h(event as any);\n    }\n  }\n}\n"],"mappings":";;;;;AAAA,IAQa;AARb;AAAA;AAQO,IAAM,WAAN,MAAe;AAAA,MACZ,WAA2C,oBAAI,IAAI;AAAA,MACnD,cAAiC,oBAAI,IAAI;AAAA,MAEjD,GAAiB,WAAmB,SAAwC;AAC1E,cAAM,MAAM,KAAK,SAAS,IAAI,SAAS,KAAK,oBAAI,IAAkB;AAClE,YAAI,IAAI,OAAO;AACf,aAAK,SAAS,IAAI,WAAW,GAAG;AAChC,eAAO;AAAA,UACL,aAAa,MAAM;AACjB,gBAAI,OAAO,OAAO;AAAA,UACpB;AAAA,QACF;AAAA,MACF;AAAA,MAEA,MAAM,SAAqC;AACzC,aAAK,YAAY,IAAI,OAAO;AAC5B,eAAO,EAAE,aAAa,MAAM,KAAK,YAAY,OAAO,OAAO,EAAE;AAAA,MAC/D;AAAA,MAEA,MAAM,KAAK,OAAgD;AACzD,cAAM,OAAQ,OAAe,SAAS,QAAS,OAAe,QAAQ;AACtE,cAAM,OAAuB;AAAA,UAC3B,GAAG,MAAM,KAAK,KAAK,WAAW;AAAA,UAC9B,GAAG,MAAM,KAAK,KAAK,SAAS,IAAI,IAAI,KAAK,CAAC,CAAC;AAAA,QAC7C;AACA,mBAAW,KAAK,MAAM;AAGpB,gBAAM,EAAE,KAAY;AAAA,QACtB;AAAA,MACF;AAAA,IACF;AAAA;AAAA;","names":[]}